<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">

        <!-- BOOTSTRAP STUFF -->
        <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
        <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
        
        <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
        <script src="https://npmcdn.com/bootstrap@4.0.0-alpha.5/dist/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

        <!-- D3 -->
        <script src="http://d3js.org/d3.v4.min.js"></script>

    </head>


<!--         <style>
        body {
          font-family: "courier";
        }
    </style> -->
    <body>
        <h1>Autonomous Vehicles</h1>
        <div id="option">
            <input name="nextButton" 
                   type="button" 
                   id="nextButton"
                   value="Next Year" 
                   onclick="updateData()" />
        </div>
        <div id="svgCanvas"></div>


        <script type="text/javascript">
        
        // Shout out to StackOverflow
        // http://stackoverflow.com/a/16788240/1031615
        jQuery.fn.extend({
            disable: function(state) {
                return this.each(function() {
                    var $this = $(this);
                    if($this.is('input, button, textarea, select'))
                      this.disabled = state;
                    else
                      $this.toggleClass('disabled', state);
                });
            }
        });


        /* CONSTANTS */

        LOG_ACTIONS = false;
        RADIANS_TO_DEGREES = (360.0/(2 * Math.PI));

        canvasWidth = 800.0;
        canvasHeight = 650.0;

        mainRadius = 270.0;
        mainStrokeWidth = 5.0

        personRadius = 8;
        startupRadius = 15;
        companyRadius = 20;

        techColor = "#32CD32";
        carColor = "#DB7093";
        startupColor = "#4682B4";
        neutralColor = "#A0A0A0"

        personTextSize = 10.0;
        companyTextSize = 16.0;

        kIndexTech = 0;
        kIndexCar = 1;
        kIndexStartUp = 2;

        currentYear = 2008;

        companyTypes = [{   'type': 'tech',
                            'color' : techColor,
                            'radius' : companyRadius},
                        {   'type' :'car',
                            'color' :carColor,
                            'radius' : companyRadius},
                        {   'type': 'startup',
                            'color' : startupColor,
                            'radius' : startupRadius}];

        // light to dark order: 2, 4, 1, 3
        colors = [  ["#53D953", "#039403", "#7FE77F", "#09C409",], // greens
                    [ "#EB9CB4", "#9B264C", "#F5C7D6", "#BA456A",], // pinks
                    ["#6AA0CC", "#12538A", "#9CC3E4", "#2B6BA0",]] // blues
        colorIndex = [0, 0, 0];

        d3.csv("industry.csv", function(d) {
            allData = {};
            for (row in d) {
                item = d[row];
                if (allData[item.year] == undefined) {
                    allData[item.year] = []
                }
                allData[item.year].push(item)
            }
            setupCanvas();
        });


        /*
         *  ANIMATION FUNCTIONS
         */
        function updateData() {
            currentYear++;
            maxYear = 2011;

            if (currentYear > maxYear) {
                resetCanvas();
                currentYear = 2007;
                updateYearText();
                return;
            }
            runYear(currentYear);
        }

        function runYear(year) {
            // Disable the button
            $("#nextButton").disable(true);

            totalDelay = clearCanvas();
            toAddDelay = 0.0;

            updateYearText(totalDelay);
            totalDelay += 500.0; // Add some time for switching the year

            // Hack to not cut off the first item
            dataRun = d3.selectAll("something");

            // RUN NEW COMPANIES STARTING
            dataRun.data(allData[year])
                .enter()
                .filter(function(d) {
                    return d.action == "start" && (toAddDelay = 1000)
                })
                .each(function(d) {
                    totalDelay += 150;
                    delay = totalDelay;
                    callAfterDelay(delay, function() {
                        addCompany(indexForActorType(d.actorType), d.actor);
                    });
                })

            totalDelay += toAddDelay;
            toAddDelay = 0.0;

            // RUN ACQUISITIONS
            dataRun.data(allData[year])
                .enter()
                .filter(function(d) {
                    return d.action == "acquire" && (toAddDelay = 2000)
                })
                .each(function(d, i) {
                    btwDelay = 500.0;
                    totalDelay += btwDelay;
                    delay = totalDelay;
                    callAfterDelay(delay, function() {
                        acquireStartup(d.actor, d.obj1);
                    });
                });

            // RUN POACHES
            totalDelay += toAddDelay;
            toAddDelay = 0.0;

            totalHires = {};
            iteratorHires = {}

            dataRun.data(allData[year])
                .enter()
                .filter(function(d) {
                    return (d.action == "poach") && addToHires(d.obj1) && (toAddDelay = 1800.0);
                })
                .each(function (d, i) {
                    btwDelay = 50.0;
                    totalDelay += btwDelay;
                    delay = totalDelay;
                    callAfterDelay(delay, function() {
                        personPoachedByCompany(d.actor, d.obj1, iteratorHires[d.obj1], totalHires[d.obj1]);
                        iteratorHires[d.obj1] = iteratorHires[d.obj1] + 1;
                    })
                })
                ;

            totalDelay += toAddDelay;
            toAddDelay = 0.0;

            // RUN HIRES
           dataRun.data(allData[year])
                .enter()
                .filter(function(d) {
                    return (d.action == "hire") && addToHires(d.obj1) && (toAddDelay = 1500)
                })
                .each(function(d, i, a) {
                    btwDelay = 250
                    totalDelay += btwDelay;
                    delay = totalDelay;
                    callAfterDelay(delay, function() {
                        addPersonToTypeCompany(d.actor, d.obj1, iteratorHires[d.obj1], totalHires[d.obj1]);
                        iteratorHires[d.obj1] = iteratorHires[d.obj1] + 1;
                    });
                })

            totalDelay += toAddDelay;
            toAddDelay = 0.0;


            callAfterDelay(totalDelay, function() {
                $("#nextButton").disable(false);
            });

            function addToHires(d) {
                if (totalHires[d] == undefined) {
                    totalHires[d] = 0;
                }
                totalHires[d] = totalHires[d] + 1;
                iteratorHires[d] = 0;
                return true;
            }
        }

         /*
          * CANVAS
          */
        function setupCanvas() {
            svg = d3.select("#svgCanvas")
                    .append("svg")
                    .attr("width", canvasWidth)
                    .attr("height", canvasHeight)

            // Add a rectangle so we can always see our canvas size
            svg.append("rect")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("fill", "#FFFFFF");

            // Add the different arcs

            centerTransform = translateXY([canvasWidth/2, canvasHeight/2]);
            for (i = 0; i < companyTypes.length; i++) {
                angle = (2/3 * Math.PI);
                var arc = d3.arc()
                    .innerRadius(mainRadius)
                    .outerRadius(mainRadius + 5)
                    .startAngle(angle * i) 
                    .endAngle(angle * (i+1));
                svg.append("path")
                    .attr("id", companyTypes[i].type)
                    .attr("fill", companyTypes[i].color)
                    .attr("d", arc)
                    .attr("transform", centerTransform)
                    .each(function(d) {
                        companyTypes[i]['path'] = this;
                    });
            }

            // Build the main arc for calculating things
            var mainArc = d3.arc()
                            .innerRadius(mainRadius)
                            .outerRadius(mainRadius + 5)
                            .startAngle(0)
                            .endAngle(2 * Math.PI)
            svg.append("path")
                .attr("d", mainArc)
                .attr("id", "mainPath")
                .attr("transform", centerTransform)
                .attr("fill", "none");

            // Add the year text
            yearFont = 45.0;
            margin = 10;
            svg.append("text")
                .attr("id", "yearText")
                .style("font-size", yearFont)
                .attr("x", margin)
                .attr("y", yearFont + margin);
            runYear(currentYear);

            radialMultiplier = 3.5;
            calcArc = d3.arc()
                        .innerRadius(companyRadius * radialMultiplier)
                        .outerRadius(companyRadius * radialMultiplier + 1)
                        .startAngle(0)
                        .endAngle(2 * Math.PI);

            calcCircle = svg.append("g")
                            .attr("id", "arcCont")
                            .attr("transform", centerTransform)
                            .append("path")
                            .attr("id", "calcArc")
                            .attr("d", calcArc)
                            .attr("fill", "none")
                            ;

        }

        function resetCanvas() {
            colorIndex = [0, 0, 0]
            svg.selectAll('g')
                .filter(function() {
                    return ['person', 'tech', 'car', 'startup', 'to-remove', 'to-fade' 'placed-person'].indexOf(d3.select(this).attr("class")) != -1;
                })
                .each(function() {
                    removeElement(this);
                })
        }

        function clearCanvas(duration) {
            // Remove people
            delay = 0.0
            duration = 750.0;
            d3.selectAll(".person")
                .attr("class", "placed-person")
                .each(function() {
                    delay = duration + 500;
                })
                .transition()
                .duration(duration)
                .ease(d3.easeBack)
                .attr("transform", function() {
                    companyId  = d3.select(this).attr("_companyId");
                    newTrans = d3.select("#" + companyId)
                                    .attr("transform");
                    return newTrans;
                })
                .style("opacity", 0.0);

            toRemoves = d3.selectAll(".to-remove")
                            .each(function() {
                                removeElement(this)
                            });
            toFades = d3.selectAll(".to-fade")
                        .transition()
                        .duration(250)
                        .style("opacity", 0.0)
                        .on("end", function() {
                            removeElement(this)
                        });
            return delay;
        }

        function removeElement(node, duration) {
            var isCircle = false;
            if (duration == undefined) duration = 250;
            element = d3.select(node)
            element.selectAll("text")
                .transition()
                .duration(duration)
                .attr("fill-opacity", 0);
            element.select("circle")
                        .transition()
                        .duration(duration)
                        .attr("r", 0)
                        .each(function() {
                            isCircle = true;
                        })
                        .on("end", function(){
                            this.parentNode.remove();
                        });
            if (isCircle == false) {
                node.remove();
            }

        }

        function updateYearText(delay) {
            if (delay == undefined) delay = 0.0
                callAfterDelay(delay, function() {
                    d3.select("#yearText")
                        .text(currentYear);
                });
        }

        /*
         *  PEOPLE METHODS
         */
        function addPersonToTypeCompany(personName, companyName, index, total) {
            company = d3.select("g#" + id(companyName));
            companyTransform = personLocationForCompany(companyName, index, total)
            color = company.select("circle").attr("fill");

            person = svg.append("g")
            person.attr("class", "person")
                .attr("id", id(personName))
                .attr("_companyId", company.attr("id"))
                .attr("transform", companyTransform)
            person.append("circle")
                .attr("fill", color)
                .attr("r", 0)
                .transition()
                .ease(d3.easeElastic)
                .duration(500)
                .attr("r", personRadius)
            person.append("text")
             .style("opacity", 0.0)
             .text(personName)
             .attr("font-size", personTextSize + "px")
             .each(function() {
                orient = rotateOrientation(company.select("text").attr("_orientation"), 2);
                orientText(this.parentNode, orient, personRadius);
             })
             .transition()
             .duration(250)
             .style("opacity", 1.0);

              drawLineFromPersonToCompany(personName, companyName)

        }



        function personPoachedByCompany(personName, poacherName, index, total) {
            // TODO deal with indices
            person = d3.select("#" + id(personName));
            // Move them to their original company
            origCompanyId = person.attr("_companyId");
            origTransform = d3.select("#" + origCompanyId)
                                .attr("transform");
            person.attr("transform", origTransform);

            poacher = d3.select("#" + id(poacherName))
            poacherColor = poacher.select("circle")
                                .attr("fill");


            poacherTransform = personLocationForCompany(poacherName, index, total)

            person.select("text")
                     .each(function() {
                        orient = rotateOrientation(poacher.select("text").attr("_orientation"), 2);
                        orientText(this.parentNode, orient, personRadius);
                 });

            person.attr("class", "person")
                .attr("_companyId", id(poacherName))
                .style("opacity", 1.0) // Show the person again.
                .transition()
                .duration(1800)
                .attr("transform", poacherTransform)
                .on("end", function() {
                    drawLineFromPersonToCompany(personName, poacherName);
                })
            person.select("circle")
                    .transition()
                    .delay(600) // Wait a bit to change the color
                    .duration(1500)
                    .attr("fill", poacherColor)
                ;
        }

        /*
         *  STARTUP METHODS
         */
         function acquireStartup(acquirerName, startupName) {
            startup = companyTypes[kIndexStartUp];

            acquirer = d3.select("g#" + id(acquirerName));
            acquirerTransform = acquirer.attr("transform")

            duration = 2000;

            // Move the startup
            svg.select("#" + id(startupName))
                .attr("class", "to-remove")
                .each(function() {
                    addAcquiredCompany(acquirerName, startupName, duration - 500);
                })
                .transition()
                .duration(duration)
                .attr("transform", acquirerTransform)


            // Shift all the other startups
            shiftDelay = 500;
            companyIter = 0;
            companyCount = countCompanyType(startup.type)
            svg.selectAll("." + startup.type)
            .filter(function() {
                return d3.select(this).attr("id") != id(startupName);
            })
            .each(function() {
                d3.select(this)
                    .transition()
                    .delay(shiftDelay)
                    .duration(duration - shiftDelay)
                    .attr("_relIndex", companyIter)
                    .attr("transform", transForEdgeIndex(startup.path, companyIter + 1, companyCount + 1));
                companyIter++;
            });

         }

        /*
         *  COMPANY METHODS
         */

         function addCompany(indexType, name) {
            company = companyTypes[indexType];
            companyCount = countCompanyType(company.type);
            companyIter = 0;
            color = colors[indexType][colorIndex[indexType]];
            colorIndex[indexType] = (colorIndex[indexType] + 1)%(colors[indexType].length);

            // Shift all the other companies
            svg.selectAll("." + company.type)
                .each(function() {
                    d3.select(this)
                        .attr("_relIndex", companyIter)
                        .transition()
                        .attr("transform", transForEdgeIndex(company.path, companyIter + 1, companyCount + 2));
                    companyIter++;
                });

            g = svg.append("g")
                .attr("class", company.type)
                .attr("id", id(name))
                .attr("_relIndex", companyCount)
                .attr("transform", transForEdgeIndex(company.path, companyCount + 1, companyCount + 2))

            g.append("circle")
            .attr("fill", color)
            .attr("r", 0)
            .transition()
                .attr("r", company.radius);

            g.append("text")
             .attr("fill-opacity", 1.0)
              .attr("font-size", companyTextSize + "px")
             .text(name)
             .each(function() {
                orientText(this.parentNode, orientationForIndex(indexType), company.radius)
             });
        }

        function addAcquiredCompany(companyName, acquiredName, delay) {
            company = d3.select("#" + id(companyName));
            acquired = d3.select("#" + id(acquiredName));

            companyText = company.selectAll("text").last();
            companyTextX = +companyText.attr("x");
            companyTextY = +companyText.attr("y");
            companyTextY +=  companyTextSize + 7.0;

            console.log(companyTextY)
            acquired.selectAll("text")
                    .transition()
                    .delay(delay - 250)
                    .duration(250)
                    .style("opacity", 0.0);

            company.append("text")
                    .attr("class", "to-fade")
                    .text(acquiredName)
                    .attr("x", companyTextX)
                    .attr("y", companyTextY)
                    .attr("font-style", "italic")
                    .attr("fill", acquired.select("circle").attr("fill"))
                    .style("opacity", 0.0)
                    .transition()
                    .delay(delay)
                    .duration(250)
                    .style("opacity", 1.0);
        }

         // COMPANY HELPER FUNCTIONS

         function transForEdgeIndex(companyPath, index, total) {
            trans = xyTranslate(d3.select(companyPath).attr("transform"));
            path = companyPath
            totalLength = path.getTotalLength();
            newPoint = path.getPointAtLength((index/total) * (totalLength/2));
            trans[0] = newPoint.x + trans[0];
            trans[1] = newPoint.y + trans[1];
            return translateXY(trans)
        }

        function countCompanyType(companyType) {
            companyCount = 0;
            svg.selectAll("." + companyType)
                .each(function() {
                    companyCount++;
                });
            return companyCount;
        }

        function personLocationForCompany(companyName, index, total) {
            element = d3.select("#" + id(companyName));
            type = element.attr("class");

            translate = xyTranslate(element.attr("transform"));

            calcCircle = d3.select("#calcArc").node();
            radialDiff = Math.PI * .9;
            radians = complement(radiansOfCompany(companyName));
            radians += radialDiff/2.0 - (radialDiff * (index + 1)/(total + 1));
            // Hack to get around negative percents
            if (radians < 0.0) {
                radians += 2.0 * Math.PI
            }

            percent = radians /(2.0 * Math.PI);
            point = calcCircle.getPointAtLength(calcCircle.getTotalLength() * percent/2.0)

            xOffset = yOffset = 0.0;
            translate[0] += point.x + xOffset;
            translate[1] += point.y + yOffset;
            return translateXY(translate);
        }
        /*
         * TEST FUNCTIONS
         */

        function demonstrateCompanyAdds() {
            count = 0;
            setInterval(function() {
                addCompany(count%3, "Gabells" + count);
                count++;
            }, 1000);
        }

        function demonstratePeopleAdds() {
            count = 0;
            setInterval(function() {
                addPersonToTypeCompany("Lucia" + c, "Gabbels1");
                count = (count+1) % 3;
            }, 2000);
        }

        function testAnimations() {
            // Populate some companies
            for (i = 0; i < 10; i++) {
                c = 0;
                callAfterDelay(i * 100, function(){
                    addCompany(c%3, "Gabbels" + c);
                    c++;
                })
            }
            callAfterDelay(1600, function() {
                acquireStartup("Gabbels0", "Gabbels5")
                // addPersonToTypeCompany("Lucia", "Gabbels1");
            });

            callAfterDelay(4500, function() {
                addCompany(kIndexStartUp, "Snabbels")
            });
        }

        // testAnimations();
        // demonstratePeopleAdds()
        // demonstrateCompanyAdds();


        /*
        * HELPER METHODS
        */

        function drawLineFromPersonToCompany(personName, companyName) {
            person = d3.select("#" + id(personName));
            personCenter = xyTranslate(person.attr("transform"))

            company = d3.select("#" + id(companyName));
            companyCenter = xyTranslate(company.attr("transform"));

            var lineData = [{"x": personCenter[0], "y": personCenter[1]},
                            {"x": companyCenter[0], "y": companyCenter[1]}];

            var lineFunction = d3.line()
                  .x(function(d) { return d.x;})
                  .y(function(d) { return d.y;});


            svg.append("g")
                .attr("class", "to-remove")
                .append("path")
                .attr("d", lineFunction(lineData))
                .attr("stroke", company.select("circle").attr("fill"))
                .style("opacity", 0.0)
                .transition()
                .duration(250)
                .style("opacity", 0.2);
        }

        function radiansOfCompany(companyName) {
            element = d3.select("#" + id(companyName));
            relIndex = +(element.attr("_relIndex"));
            type = element.attr("class")
            elementCount = 0.0;

            d3.selectAll("." + type)
                .each(function() {
                    elementCount++;
                });

            smallArc = (2.0/3.0 * Math.PI)
            radians = smallArc * parseFloat(indexForActorType(type))
            radians += smallArc * (relIndex + 1.0)/(elementCount + 1.0)
            return radians;
        }

        function complement(radians) {
            // Hacky but it works.
            if (radians == Math.PI || radians == -Math.PI) return 0.0;
            if (radians < Math.PI) c = Math.PI + radians;
            else c = radians - Math.PI;
            return +c;
        }

        function orientText(element, orientation, radius) {
            margin = 4.0;

            baseline = "middle"
            textAnchor = "middle"
            offset = radius + margin;
            x = 0;
            y = 0;

            if (orientation == "right") {
                x = offset;
                textAnchor = "left";
            } else if (orientation == "left") {
                x = -offset;
                textAnchor = "end";
            } else if (orientation == "bottom") {
                y = offset;
                baseline = "hanging";
            } else if (orientation == "top") {
                y = -offset;
                baseline = "baseline";
            } else {
                console.warn("Bad orientation " + orientation);
                return;
            }

            d3.select(element)
                .select("text")
                .style("alignment-baseline", baseline)
                .attr("text-anchor", textAnchor)
                .attr("x", x)
                .attr("y", y)
                .attr("_orientation", orientation);
        }

        function rotateOrientation(o, cardDegrees) {
            // Each cardDegree turns it 90 degrees to the right
            orientations = ["top", "right", "bottom", "left"];
            return orientations[(orientations.indexOf(o) + 2)%4]
        }

        function orientationForIndex(companyIndex) {
            if (companyIndex == 0) return "right";
            if (companyIndex == 1) return "bottom";
            if (companyIndex == 2) return "left";
        }

        function callAfterDelay(delay, func) {
            setTimeout(func, delay);
        }

        function translateXY(xy) {
          return 'translate(' + xy[0] + ',' + xy[1] + ')';
        }

        function xyTranslate(translate) {
          translate = translate.replace('translate(', '')
          translate = translate.replace(')', '');
          translate = translate.split(',');
          for (var i in translate) {
            translate[i] = +translate[i];
          }
          return translate;
        }

        function indexForActorType(cType) {
            if (cType == "tech") {
                return kIndexTech;
            } else if (cType == "car") {
                return kIndexCar;
            } else if (cType == "startup") {
                return kIndexStartUp;
            } else {
                console.warn("Bad type " + cType);
            }
        }

        function id(name) {
          return name.replace(/\W/g, '')
        }

        // Get the first or last child
        // Shout out to StackOverflow
        // http://stackoverflow.com/a/25413534/1031615
        d3.selection.prototype.first = function() {
            return d3.select(this.nodes()[0])
        };
        d3.selection.prototype.last = function() {
            return d3.select(this.nodes()[this.nodes().length-1])
        };

        </script>
    </body>
</html>  

























