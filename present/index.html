<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <script src="http://d3js.org/d3.v4.min.js"></script>
    </head>
    <style>
        body {
          font-family: "courier";
        }
    </style>
    <body>
        <h1>Autonomous Vehicles</h1>
        <div id="option">
            <input name="nextButton" 
                   type="button" 
                   value="Next Year" 
                   onclick="updateData()" />
        </div>
        <div id="svgCanvas"></div>


        <script type="text/javascript">
        
        /* CONSTANTS */

        canvasWidth = 750.0;
        canvasHeight = 750.0;

        mainRadius = 250.0;
        mainStrokeWidth = 5.0

        personRadius = 15;

        techColor = "#32CD32";
        carColor = "#DB7093";
        startupColor = "#4682B4";
        neutralColor = "#A0A0A0"

        kIndexTech = 0;
        kIndexCar = 1;
        kIndexStartUp = 2;

        currentYear = 2008;

        companyTypes = [{   'type': 'tech',
                            'color' : techColor,
                            'radius' : 35},
                        {   'type' :'car',
                            'color' :carColor,
                            'radius' : 35},
                        {   'type': 'startup',
                            'color' : startupColor,
                            'radius' : 20}];


        d3.csv("industry.csv", function(d) {
            allData = {};
            for (row in d) {
                item = d[row];
                if (allData[item.year] == undefined) {
                    allData[item.year] = []
                }
                allData[item.year].push(item)
            }
            setupCanvas();
        });


        /*
         *  ANIMATION FUNCTIONS
         */
        function updateData() {
            currentYear++;
            maxYear = 2011;

            if (currentYear > maxYear) {
                resetCanvas();
                currentYear = 2007;
                updateYearText();
                return;
            }
            runYear(currentYear);
        }

        function runYear(year) {
            updateYearText();
            yearData = allData[year]
            actionFunctions = {}
            for (i in yearData) {                
                a = yearData[i]
                if (actionFunctions[a.action] == undefined) {
                    actionFunctions[a.action] = []
                }
                actionFunctions[a.action].push([funcForAction(a.action), a]);
            }

            // Run start functions

            betweenDelay = 200;
            clearCanvas(betweenDelay);
            if (actionFunctions.start != undefined) {
                runActionsWithDelay(actionFunctions.start, betweenDelay);
                betweenDelay += 1000;

            }
            if (actionFunctions.hire != undefined) {
                runActionsWithDelay(actionFunctions.hire, betweenDelay, btwTime=1000);
                betweenDelay += 1000;
            }
            if (actionFunctions.acquire != undefined) {
                runActionsWithDelay(actionFunctions.acquire, betweenDelay, btwTime=500);
                betweenDelay += 1000;
            }

            function runActionsWithDelay(actions, delay, btwTime) {
                if (btwTime == undefined) btwTime = 20;
                callAfterDelay(betweenDelay, function() {
                    for (s in actions) {
                        count = 0;
                        callAfterDelay(s * btwTime, function() {
                            func = actions[count][0]
                            a = actions[count][1]
                            console.log(a.actor + " " + a.action)
                            func(a.actor, a.actorType, a.obj1)
                            count++;
                        });
                    }
                });
            }
        }

         function funcForAction(action) {
            if (action == "start") {
                return animateCompanyStart;
            } if (action == "hire") {
                return animateHire;
            } if (action == "acquire") {
                return animateAcquire;
            } else {
                console.warn("Undefined function for action " + action);
            }
         }

         function animateCompanyStart(actor, actorType, obj1) {
            addCompany(indexForActorType(actorType), actor);
         }
         function animateHire(actor, actorType, obj1) {
            addPersonToTypeCompany(actor, obj1);
         }
          function animateAcquire(actor, actorType, obj1) {
            acquireStartup(actor, obj1);
         }

         /*
          * CANVAS
          */
        function setupCanvas() {
            svg = d3.select("#svgCanvas")
                    .append("svg")
                    .attr("width", canvasWidth)
                    .attr("height", canvasHeight)

            // Add a rectangle so we can always see our canvas size
            svg.append("rect")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("fill", "#faebd7");

            // Add the different arcs
            for (i = 0; i < companyTypes.length; i++) {
                angle = (2/3 * Math.PI);
                var arc = d3.arc()
                    .innerRadius(mainRadius)
                    .outerRadius(mainRadius + 5)
                    .startAngle(angle * i) 
                    .endAngle(angle * (i+1));
                svg.append("path")
                    .attr("id", companyTypes[i].type)
                    .attr("fill", companyTypes[i].color)
                    .attr("d", arc)
                    .attr("transform", translateXY([canvasWidth/2, canvasHeight/2]))
                    .each(function(d) {
                        companyTypes[i]['path'] = this;
                    });
            }

            // Add the year text
            yearFont = 45.0;
            margin = 10;
            svg.append("text")
                .attr("id", "yearText")
                .style("font-size", yearFont)
                .attr("x", margin)
                .attr("y", yearFont + margin);
            runYear(currentYear);
        }

        function resetCanvas() {
            // called = false;
            svg.selectAll('g')
                .filter(function() {
                    return ['person', 'tech', 'car', 'startup', 'to-remove'].indexOf(d3.select(this).attr("class")) != -1;
                })
                .each(function() {
                    d = 250;
                    g = d3.select(this)
                    g.select('circle')
                        .transition()
                        .duration(d)
                        .attr("r", 0);
                    g.select('text')
                        .transition()
                        .duration(d)
                        .attr("fill-opacity", 0)
                        .on("end", function(){
                            this.parentNode.remove();
                            // if (called == false) {
                            //     runYear(currentYear);
                            //     called = true;
                            // }
                            // d3.select(this.parentNode()).remove()
                        })
                })
        }

        function clearCanvas(duration) {
            // Remove people
            d3.selectAll(".person")
                .each(function() {
                    removeElement(this)
                });
            toRemoves = d3.selectAll(".to-remove")
                            .each(function() {
                                removeElement(this)
                            });
        }

        function removeElement(node, duration) {
            if (duration == undefined) duration = 250;
            element = d3.select(node)
            element.select("text")
                .transition()
                .duration(duration)
                .attr("fill-opacity", 0);
            element.select("circle")
                        .transition()
                        .duration(duration)
                        .attr("r", 0)
                        .on("end", function(){
                            this.parentNode.remove();
                        });

        }



        function updateYearText() {
            d3.select("#yearText")
                .text(currentYear);
        }

        /*
         *  PEOPLE METHODS
         */

        function addPersonToTypeCompany(personName, companyName) {
            company = d3.select("g#" + companyName);
            companyTransform = company.attr("transform")
            color = company.select("circle").attr("fill");

            duration = 1200;
            delay = 0;


            neutralPerson(personName, function(person) {
                colorChangeRatio = .8;
                p = d3.select(person)
                p.select("circle")
                    .transition()
                    .duration(duration * colorChangeRatio)
                    .attr("fill", color)
                    // TODO Remove this l8r
                    .on("end", function() {
                        d3.select(this.parentNode)
                        .transition()
                        .delay(duration * (1 - colorChangeRatio))
                        .select("text")
                            .attr("fill-opacity", 0.0);
                    });

                p.transition()
                    .delay(delay)
                    .duration(duration)
                    .ease(d3.easeCubic)
                    .attr("transform", companyTransform);

            });

        }

        function neutralPerson(name, completion) {
            person = svg.insert("g", "#yearText")
            person.attr("class", "person")
                .attr("transform", translateXY([canvasWidth/2, canvasHeight/2]))
            person.append("circle")
                .attr("fill", neutralColor)
                .attr("r", 0)
                .transition()
                .ease(d3.easeElastic)
                .duration(500)
                .attr("r", personRadius)
                .on("end", function() {
                    if (completion != undefined) {
                        completion(this.parentNode);
                    }
                });
                person.append("text")
                 .attr("fill-opacity", 1.0)
                 .text(name)


            // return person;
        }

        /*
         *  STARTUP METHODS
         */
         function acquireStartup(acquirerName, startupName) {
            startup = companyTypes[kIndexStartUp];

            acquirer = d3.select("g#" + acquirerName);
            acquirerTransform = acquirer.attr("transform")

            duration = 1500;

            // Move the startup
            svg.select("#" + startupName)
                .attr("class", "to-remove")
                .transition()
                .duration(duration)
                .attr("transform", acquirerTransform);

            // Shift all the other startups
            shiftDelay = 500;
            companyIter = 0;
            companyCount = countCompanyType(startup.type)
            svg.selectAll("." + startup.type)
            .filter(function() {
                return d3.select(this).attr("id") != startupName;
            })
            .each(function() {
                d3.select(this)
                    .transition()
                    .delay(shiftDelay)
                    .duration(duration - shiftDelay)
                    .attr("transform", transForEdgeIndex(startup.path, companyIter + 1, companyCount + 1));
                companyIter++;
            });

         }

        /*
         *  COMPANY METHODS
         */

         function addCompany(indexType, name) {
            company = companyTypes[indexType];
            companyCount = countCompanyType(company.type);
            companyIter = 0;

            // Shift all the other companies
            svg.selectAll("." + company.type)
                .each(function() {
                    d3.select(this)
                        .transition()
                        // .duration(500)
                        .attr("transform", transForEdgeIndex(company.path, companyIter + 1, companyCount + 2));
                    companyIter++;
                });

            g = svg.append("g")
                .attr("class", company.type)
                .attr("id", name)
                .attr("transform", transForEdgeIndex(company.path, companyCount + 1, companyCount + 2))

            g.append("circle")
            .attr("fill", company.color)
            .attr("r", 0)
            .transition()
                .attr("r", company.radius)

            g.append("text")
             .attr("fill-opacity", 1.0)
             .text(name);
         }

         // COMPANY HELPER FUNCTIONS

         function transForEdgeIndex(companyPath, index, total) {
            trans = xyTranslate(d3.select(companyPath).attr("transform"));
            path = companyPath
            totalLength = path.getTotalLength();
            newPoint = path.getPointAtLength((index/total) * (totalLength/2));
            trans[0] = newPoint.x + trans[0];
            trans[1] = newPoint.y + trans[1];
            return translateXY(trans)
        }

        function countCompanyType(companyType) {
            companyCount = 0;
            svg.selectAll("." + companyType)
                .each(function() {
                    companyCount++;
                });
            return companyCount;
        }

        /*
         * TEST FUNCTIONS
         */
        function demonstrateCompanyAdds() {
            count = 0;
            setInterval(function() {
                addCompany(count, "Gabells");
                count = (count+1) % 3;
            }, 2000);
        }

        function demonstratePeopleAdds() {
            count = 0;
            setInterval(function() {
                addPersonToTypeCompany("Lucia" + c, "Gabbels1");
                count = (count+1) % 3;
            }, 2000);
        }

        function testAnimations() {
            // Populate some companies
            for (i = 0; i < 10; i++) {
                c = 0;
                callAfterDelay(i * 100, function(){
                    addCompany(c%3, "Gabbels" + c);
                    c++;
                })
            }
            callAfterDelay(1600, function() {
                acquireStartup("Gabbels0", "Gabbels5")
                // addPersonToTypeCompany("Lucia", "Gabbels1");
            });

            callAfterDelay(4500, function() {
                addCompany(kIndexStartUp, "Snabbels")
            });
        }

        // testAnimations();
        // demonstratePeopleAdds()
        // demonstrateCompanyAdds();


        /*
        * HELPER METHODS
        */
        function callAfterDelay(delay, func) {
            setTimeout(func, delay);
        }

        function translateXY(xy) {
          return 'translate(' + xy[0] + ',' + xy[1] + ')';
        }

        function xyTranslate(translate) {
          translate = translate.replace('translate(', '')
          translate = translate.replace(')', '');
          translate = translate.split(',');
          for (var i in translate) {
            translate[i] = +translate[i];
          }
          return translate;
        }

        function indexForActorType(cType) {
            if (cType == "tech") {
                return kIndexTech;
            } else if (cType == "car") {
                return kIndexCar;
            } else if (cType == "startup") {
                return kIndexStartUp;
            } else {
                console.warn("Bad type " + cType);
            }
        }
        </script>
    </body>
</html>  