<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">

        <!-- BOOTSTRAP STUFF -->
        <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
        <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
        
        <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
        <script src="https://npmcdn.com/bootstrap@4.0.0-alpha.5/dist/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

        <!-- D3 -->
        <script src="http://d3js.org/d3.v4.min.js"></script>

    </head>


        <style>
        body {
          font-family: "courier";
        }
    </style>
    <body>
        <h1>Autonomous Vehicles</h1>
        <div id="option">
            <input name="nextButton" 
                   type="button" 
                   value="Next Year" 
                   onclick="updateData()" />
        </div>
        <div id="svgCanvas"></div>


        <script type="text/javascript">
        
        /* CONSTANTS */

        LOG_ACTIONS = false;
        RADIANS_TO_DEGREES = (360.0/(2 * Math.PI));

        canvasWidth = 750.0;
        canvasHeight = 700.0;

        mainRadius = 250.0;
        mainStrokeWidth = 5.0

        personRadius = 15;
        companyRadius = 30;

        techColor = "#32CD32";
        carColor = "#DB7093";
        startupColor = "#4682B4";
        neutralColor = "#A0A0A0"

        kIndexTech = 0;
        kIndexCar = 1;
        kIndexStartUp = 2;

        currentYear = 2008;

        companyTypes = [{   'type': 'tech',
                            'color' : techColor,
                            'radius' : companyRadius},
                        {   'type' :'car',
                            'color' :carColor,
                            'radius' : companyRadius},
                        {   'type': 'startup',
                            'color' : startupColor,
                            'radius' : 20}];


        d3.csv("industry.csv", function(d) {
            allData = {};
            for (row in d) {
                item = d[row];
                if (allData[item.year] == undefined) {
                    allData[item.year] = []
                }
                allData[item.year].push(item)
            }
            setupCanvas();
        });


        /*
         *  ANIMATION FUNCTIONS
         */
        function updateData() {
            currentYear++;
            maxYear = 2011;

            if (currentYear > maxYear) {
                resetCanvas();
                currentYear = 2007;
                updateYearText();
                return;
            }
            runYear(currentYear);
        }

        function runYear(year) {
            updateYearText();

            totalDelay = 0;

            // Run some things first
            d3.selectAll("dataTest")
                .data(allData[year])
                .enter()
                .filter(function(d) {
                    return d.action == "start"
                })
                .each(function(d) {
                    totalDelay += 100;
                    addCompany(indexForActorType(d.actorType), d.actor);
                })

            svg.data(allData[year])
                .enter()
                .filter(function(d) {
                    return d.action == "hire"
                })
                .each(function(d, i) {
                    beforeDelay = 50;
                    btwDelay = 50
                    totalDelay += btwDelay + beforeDelay;
                    delay = totalDelay;
                    callAfterDelay(delay, function() {
                        addPersonToTypeCompany(d.actor, d.obj1);
                    });
                });

            svg.data(allData[year])
                .enter()
                .filter(function(d) {
                    return d.action == "acquire"
                })
                .each(function(d, i) {
                    beforeDelay = 1000;
                    btwDelay = 500;
                    totalDelay += btwDelay + beforeDelay;
                    delay = totalDelay;
                    callAfterDelay(delay, function() {
                        acquireStartup(d.actor, d.obj1);
                    });
                });
        }

         /*
          * CANVAS
          */
        function setupCanvas() {
            svg = d3.select("#svgCanvas")
                    .append("svg")
                    .attr("width", canvasWidth)
                    .attr("height", canvasHeight)

            // Add a rectangle so we can always see our canvas size
            svg.append("rect")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("fill", "#faebd7");

            // Add the different arcs

            centerTransform = translateXY([canvasWidth/2, canvasHeight/2]);
            for (i = 0; i < companyTypes.length; i++) {
                angle = (2/3 * Math.PI);
                var arc = d3.arc()
                    .innerRadius(mainRadius)
                    .outerRadius(mainRadius + 5)
                    .startAngle(angle * i) 
                    .endAngle(angle * (i+1));
                svg.append("path")
                    .attr("id", companyTypes[i].type)
                    .attr("fill", companyTypes[i].color)
                    .attr("d", arc)
                    .attr("transform", centerTransform)
                    .each(function(d) {
                        companyTypes[i]['path'] = this;
                    });
            }

            // Build the main arc for calculating things
            var mainArc = d3.arc()
                            .innerRadius(mainRadius)
                            .outerRadius(mainRadius + 5)
                            .startAngle(0)
                            .endAngle(2 * Math.PI)
            svg.append("path")
                .attr("d", mainArc)
                .attr("id", "mainPath")
                .attr("transform", centerTransform)
                .attr("fill", "none");

            // Add the year text
            yearFont = 45.0;
            margin = 10;
            svg.append("text")
                .attr("id", "yearText")
                .style("font-size", yearFont)
                .attr("x", margin)
                .attr("y", yearFont + margin);
            runYear(currentYear);

            radialMultiplier = 2.0;
            calcArc = d3.arc()
                        .innerRadius(companyRadius * radialMultiplier)
                        .outerRadius(companyRadius * radialMultiplier + 1)
                        .startAngle(0)
                        .endAngle(2 * Math.PI);

            calcCircle = svg.append("g")
                            .attr("id", "arcCont")
                            .attr("transform", centerTransform)
                            .append("path")
                            .attr("id", "calcArc")
                            .attr("d", calcArc)
                            // .attr("fill", "none")
                            ;

            testArc =   d3.arc()
                        .innerRadius(companyRadius * radialMultiplier)
                        .outerRadius(companyRadius * radialMultiplier + 1)
                        .startAngle(0 * -Math.PI / 2.0)
                        .endAngle(Math.PI /2.0);
            d3.select("#arcCont")
                .append("path")
                .attr("d", testArc)
                .attr("fill", "red")

        }

        function resetCanvas() {
            svg.selectAll('g')
                .filter(function() {
                    return ['person', 'tech', 'car', 'startup', 'to-remove'].indexOf(d3.select(this).attr("class")) != -1;
                })
                .each(function() {
                    d = 250;
                    g = d3.select(this)
                    g.select('circle')
                        .transition()
                        .duration(d)
                        .attr("r", 0);
                    g.select('text')
                        .transition()
                        .duration(d)
                        .attr("fill-opacity", 0)
                        .on("end", function(){
                            this.parentNode.remove();
                        })
                })
        }

        function clearCanvas(duration) {
            // Remove people
            d3.selectAll(".person")
                .each(function() {
                    removeElement(this)
                });
            toRemoves = d3.selectAll(".to-remove")
                            .each(function() {
                                removeElement(this)
                            });
        }

        function removeElement(node, duration) {
            if (duration == undefined) duration = 250;
            element = d3.select(node)
            element.select("text")
                .transition()
                .duration(duration)
                .attr("fill-opacity", 0);
            element.select("circle")
                        .transition()
                        .duration(duration)
                        .attr("r", 0)
                        .on("end", function(){
                            this.parentNode.remove();
                        });

        }

        function updateYearText() {
            d3.select("#yearText")
                .text(currentYear);
        }

        /*
         *  PEOPLE METHODS
         */

        function addPersonToTypeCompany(personName, companyName) {            
            neutralPerson(personName, d3.select("g#" + companyName), function(person, company) {
                company = d3.select("g#" + companyName);
                companyTransform = personLocationForCompany(companyName)
                color = company.select("circle").attr("fill");

                duration = 1200;
                delay = 0.0;

                colorChangeRatio = .8;
                p = d3.select(person)
                p.select("circle")
                    .transition()
                    .duration(duration * colorChangeRatio)
                    .attr("fill", color)
                    // TODO Remove this l8r
                    .on("end", function() {
                        d3.select(this.parentNode)
                        .transition()
                        .delay(duration * (1 - colorChangeRatio))
                        .select("text")
                            .attr("fill-opacity", 0.0);
                    });
                p.transition()
                    .duration(duration)
                    .ease(d3.easeCubic)
                    .attr("transform", companyTransform);
            });
        }

        function neutralPerson(name, company, completion) {
            person = svg.insert("g", "#yearText")
            person.attr("class", "person")
                .attr("transform", translateXY([canvasWidth/2, canvasHeight/2]))
            person.append("circle")
                .attr("fill", neutralColor)
                .attr("r", 0)
                .transition()
                .ease(d3.easeElastic)
                .duration(500)
                .attr("r", personRadius)
                .on("end", function() {
                    if (completion != undefined) {
                        completion(this.parentNode, company);
                    }
                });
                person.append("text")
                 .attr("fill-opacity", 1.0)
                 .text(name)
                 .each(function() {
                    orientText(this.parentNode, "top", personRadius);
                 })


            // return person;
        }

        /*
         *  STARTUP METHODS
         */
         function acquireStartup(acquirerName, startupName) {
            startup = companyTypes[kIndexStartUp];

            acquirer = d3.select("g#" + acquirerName);
            acquirerTransform = acquirer.attr("transform")

            duration = 1500;

            // Move the startup
            svg.select("#" + startupName)
                .attr("class", "to-remove")
                .transition()
                .duration(duration)
                .attr("transform", acquirerTransform);

            // Shift all the other startups
            shiftDelay = 500;
            companyIter = 0;
            companyCount = countCompanyType(startup.type)
            svg.selectAll("." + startup.type)
            .filter(function() {
                return d3.select(this).attr("id") != startupName;
            })
            .each(function() {
                d3.select(this)
                    .transition()
                    .delay(shiftDelay)
                    .duration(duration - shiftDelay)
                    .attr("_relIndex", companyIter)
                    .attr("transform", transForEdgeIndex(startup.path, companyIter + 1, companyCount + 1));
                companyIter++;
            });

         }

        /*
         *  COMPANY METHODS
         */

         function addCompany(indexType, name) {
            company = companyTypes[indexType];
            companyCount = countCompanyType(company.type);
            companyIter = 0;

            // Shift all the other companies
            svg.selectAll("." + company.type)
                .each(function() {
                    d3.select(this)
                        // .duration(500)
                        .attr("_relIndex", companyIter)
                        .transition()
                        .attr("transform", transForEdgeIndex(company.path, companyIter + 1, companyCount + 2));
                    companyIter++;
                });

            g = svg.append("g")
                .attr("class", company.type)
                .attr("id", name)
                .attr("_relIndex", companyCount)
                .attr("transform", transForEdgeIndex(company.path, companyCount + 1, companyCount + 2))

            g.append("circle")
            .attr("fill", company.color)
            .attr("r", 0)
            .transition()
                .attr("r", company.radius);

            g.append("text")
             .attr("fill-opacity", 1.0)
             .text(name)
             .each(function() {
                orientText(this.parentNode, orientationForIndex(indexType), company.radius)
             });
        }

         // COMPANY HELPER FUNCTIONS

         function transForEdgeIndex(companyPath, index, total) {
            trans = xyTranslate(d3.select(companyPath).attr("transform"));
            path = companyPath
            totalLength = path.getTotalLength();
            newPoint = path.getPointAtLength((index/total) * (totalLength/2));
            trans[0] = newPoint.x + trans[0];
            trans[1] = newPoint.y + trans[1];
            return translateXY(trans)
        }

        function countCompanyType(companyType) {
            companyCount = 0;
            svg.selectAll("." + companyType)
                .each(function() {
                    companyCount++;
                });
            return companyCount;
        }

        function personLocationForCompany(companyName) {
            element = d3.select("#" + companyName);
            type = element.attr("class");

            translate = xyTranslate(element.attr("transform"));

            calcCircle = d3.select("#calcArc").node();
            // console.log(calcCircle);
            percent = complement(radiansOfCompany(companyName))/(2.0 * Math.PI);
            point = calcCircle.getPointAtLength(calcCircle.getTotalLength() * percent/2.0)

            translate[0] += point.x;
            translate[1] += point.y;
            return translateXY(translate);
        }
        /*
         * TEST FUNCTIONS
         */

        function demonstrateCompanyAdds() {
            count = 0;
            setInterval(function() {
                addCompany(count%3, "Gabells" + count);
                count++;
            }, 1000);
        }

        function demonstratePeopleAdds() {
            count = 0;
            setInterval(function() {
                addPersonToTypeCompany("Lucia" + c, "Gabbels1");
                count = (count+1) % 3;
            }, 2000);
        }

        function testAnimations() {
            // Populate some companies
            for (i = 0; i < 10; i++) {
                c = 0;
                callAfterDelay(i * 100, function(){
                    addCompany(c%3, "Gabbels" + c);
                    c++;
                })
            }
            callAfterDelay(1600, function() {
                acquireStartup("Gabbels0", "Gabbels5")
                // addPersonToTypeCompany("Lucia", "Gabbels1");
            });

            callAfterDelay(4500, function() {
                addCompany(kIndexStartUp, "Snabbels")
            });
        }

        // testAnimations();
        // demonstratePeopleAdds()
        // demonstrateCompanyAdds();


        /*
        * HELPER METHODS
        */

        function radiansOfCompany(companyName) {
            element = d3.select("#" + companyName);
            relIndex = +(element.attr("_relIndex"));
            type = element.attr("class")
            elementCount = 0;

            d3.selectAll("." + type)
                .each(function() {
                    elementCount++;
                });

            smallArc = (2.0/3.0 * Math.PI)
            radians = smallArc * parseFloat(indexForActorType(type))
            radians += smallArc * (relIndex + 1)/(elementCount + 1)
            return radians;
        }

        function complement(radians) {
            // Hacky but it works.
            if (radians <= Math.PI) c = Math.PI + radians;
            else c = Math.abs(radians - Math.PI);
            return c;
        }

        function orientText(element, orientation, radius) {
            margin = 4.0;
            // if (radius == undefined) {
            //     radius = d3.select(element)
            //                 .select("circle")
            //                 .attr("r")
            //     console.log("Overridden radius: " + radius);
            // }
            if (orientation == "right") {
                d3.select(element)
                    .select("text")
                    .style("alignment-baseline", "middle")
                    .attr("text-anchor", "left")
                    .attr("x", radius + margin)
            } else if (orientation == "left") {
                d3.select(element)
                    .select("text")
                    .style("alignment-baseline", "middle")
                    .attr("text-anchor", "end")
                    .attr("x", 0- (radius + margin))
            } else if (orientation == "bottom") {
                d3.select(element)
                    .select("text")
                    .style("alignment-baseline", "hanging")
                    .attr("text-anchor", "middle")
                    .attr("y", radius + margin)
            } else if (orientation == "top") {
                d3.select(element)
                    .select("text")
                    .style("alignment-baseline", "baseline")
                    .attr("text-anchor", "middle")
                    .attr("y", 0 - (radius + margin))

            }
        }

        function orientationForIndex(companyIndex) {
            if (companyIndex == 0) return "right";
            if (companyIndex == 1) return "bottom";
            if (companyIndex == 2) return "left";
        }

        function callAfterDelay(delay, func) {
            setTimeout(func, delay);
        }

        function translateXY(xy) {
          return 'translate(' + xy[0] + ',' + xy[1] + ')';
        }

        function xyTranslate(translate) {
          translate = translate.replace('translate(', '')
          translate = translate.replace(')', '');
          translate = translate.split(',');
          for (var i in translate) {
            translate[i] = +translate[i];
          }
          return translate;
        }

        function indexForActorType(cType) {
            if (cType == "tech") {
                return kIndexTech;
            } else if (cType == "car") {
                return kIndexCar;
            } else if (cType == "startup") {
                return kIndexStartUp;
            } else {
                console.warn("Bad type " + cType);
            }
        }
        </script>
    </body>
</html>  