<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <script src="http://d3js.org/d3.v4.min.js"></script>
    </head>
    <body>
        <h1>Autonomous Vehicles</h1>
        <div id="svgCanvas"></div>

        <script type="text/javascript">
        
        /* CONSTANTS */

        canvasWidth = 800.0;
        canvasHeight = 700.0;

        mainRadius = 300.0;
        mainStrokeWidth = 5.0

        personRadius = 15;

        techColor = "#32CD32";
        carColor = "#DB7093";
        startupColor = "#4682B4";
        neutralColor = "#A0A0A0"

        kIndexTech = 0;
        kIndexCar = 1;
        kIndexStartUp = 2;

        companyTypes = [{   'type': 'tech',
                            'color' : techColor,
                            'radius' : 25},
                        {   'type' :'car',
                            'color' :carColor,
                            'radius' : 25},
                        {   'type': 'startup',
                            'color' : startupColor,
                            'radius' : 20}];

        svg = d3.select("#svgCanvas")
                .append("svg")
                .attr("width", canvasWidth)
                .attr("height", canvasHeight)

        // Add a rectangle so we can always see our canvas size
        svg.append("rect")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("fill", "#faebd7");

        // Add the different arcs
        for (i = 0; i < companyTypes.length; i++) {
            angle = (2/3 * Math.PI);
            var arc = d3.arc()
                .innerRadius(mainRadius)
                .outerRadius(mainRadius + 5)
                .startAngle(angle * i) 
                .endAngle(angle * (i+1));
            svg.append("path")
                .attr("id", companyTypes[i].type)
                .attr("fill", companyTypes[i].color)
                .attr("d", arc)
                .attr("transform", translateXY([canvasWidth/2, canvasHeight/2]))
                .each(function(d) {
                    companyTypes[i]['path'] = this;
                });
        }

        /*
         *  PEOPLE METHODS
         */
        function addPersonToTypeCompany(personName, companyName) {
            company = d3.select("g#" + companyName);
            companyTransform = company.attr("transform")
            color = company.select("circle").attr("fill");

            neutralPerson()
                .transition()
                .delay(500)
                .duration(1200)
                .ease(d3.easeCubic)
                .attr("transform", companyTransform)
                .attr("fill", color);
        }

        function neutralPerson() {
            return svg.append("circle")
                        .attr("class", "person")
                        .attr("fill", neutralColor)
                        .attr("transform", translateXY([canvasWidth/2, canvasHeight/2]))
                        .attr("r", 0)
                        .transition()
                        .ease(d3.easeElastic)
                        .delay(250)
                        .duration(750)
                        .attr("r", personRadius);

        }

        /*
         *  STARTUP METHODS
         */
         function companyAcquireStartup(acquirerName, startupName) {
            startup = companyTypes[kIndexStartUp];

            acquirer = d3.select("g#" + acquirerName);
            acquirerTransform = acquirer.attr("transform")

            duration = 1500;

            // Move the startup
            svg.select("#" + startupName)
                .attr("class", "to-remove")
                .transition()
                .duration(duration)
                .attr("transform", acquirerTransform);

            // Shift all the other startups
            shiftDelay = 500;
            companyIter = 0;
            companyCount = countCompanyType(startup.type)
            svg.selectAll("." + startup.type)
            .filter(function() {
                return d3.select(this).attr("id") != startupName;
            })
            .each(function() {
                d3.select(this)
                    .transition()
                    .delay(shiftDelay)
                    .duration(duration - shiftDelay)
                    .attr("transform", transForEdgeIndex(startup.path, companyIter + 1, companyCount + 1));
                companyIter++;
            });

         }

        /*
         *  COMPANY METHODS
         */

         function addCompany(indexType, name) {
            company = companyTypes[indexType];
            companyCount = countCompanyType(company.type);
            companyIter = 0;

            // Shift all the other companies
            svg.selectAll("." + company.type)
                .each(function() {
                    d3.select(this)
                        .transition()
                        // .duration(500)
                        .attr("transform", transForEdgeIndex(company.path, companyIter + 1, companyCount + 2));
                    companyIter++;
                });

            g = svg.append("g")
                .attr("class", company.type)
                .attr("id", name)
                .attr("transform", transForEdgeIndex(company.path, companyCount + 1, companyCount + 2))

            g.append("circle")
            .attr("fill", company.color)
            .attr("r", 0)
            .transition()
                .attr("r", company.radius)

            g.append("text")
             .text(name);
         }

         // COMPANY HELPER FUNCTIONS

         function transForEdgeIndex(companyPath, index, total) {
            trans = xyTranslate(d3.select(companyPath).attr("transform"));
            path = companyPath
            totalLength = path.getTotalLength();
            newPoint = path.getPointAtLength((index/total) * (totalLength/2));
            trans[0] = newPoint.x + trans[0];
            trans[1] = newPoint.y + trans[1];
            return translateXY(trans)
        }

        function countCompanyType(companyType) {
            companyCount = 0;
            svg.selectAll("." + companyType)
                .each(function() {
                    companyCount++;
                });
            return companyCount;
        }

        /*
         * TEST FUNCTIONS
         */

        function demonstrateCompanyAdds() {
            count = 0;
            setInterval(function() {
                addCompany(count, "Gabells");
                count = (count+1) % 3;
            }, 2000);
        }

        function demonstratePeopleAdds() {
            count = 0;
            setInterval(function() {
                addPersonToTypeCompany("Lucia" + c, "Gabbels1");
                count = (count+1) % 3;
            }, 2000);
        }

        // Populate some companies
        for (i = 0; i < 10; i++) {
            c = 0;
            callAfterDelay(i * 100, function(){
                addCompany(c%3, "Gabbels" + c);
                c++;
            })
        }
        callAfterDelay(1600, function() {
            companyAcquireStartup("Gabbels0", "Gabbels5")
            // addPersonToTypeCompany("Lucia", "Gabbels1");
        });

        callAfterDelay(4500, function() {
            addCompany(kIndexStartUp, "Snabbels")
        });


        // demonstratePeopleAdds()
        // demonstrateCompanyAdds();


        /*
        * HELPER METHODS
        */
        function callAfterDelay(delay, func) {
            setTimeout(func, delay);
        }
        function translateXY(xy) {
          return 'translate(' + xy[0] + ',' + xy[1] + ')';
        }

        function xyTranslate(translate) {
          translate = translate.replace('translate(', '')
          translate = translate.replace(')', '');
          translate = translate.split(',');
          for (var i in translate) {
            translate[i] = +translate[i];
          }
          return translate;
        }
        </script>
    </body>
</html>  