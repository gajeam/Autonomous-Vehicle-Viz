<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <script src="http://d3js.org/d3.v3.min.js"></script>
    </head>
    <body>
        <h1>Autonomous Vehicles</h1>
        <div id="svgCanvas"></div>

        <script type="text/javascript">
        
        /* CONSTANTS */

        canvasWidth = 700.0;
        canvasHeight = 700.0;
        
        companyWidth = canvasWidth / 6.0;
        companyHeight = canvasHeight / 8.0;
        companyColor = "#32CD32";

        startupRadius = canvasWidth / 15.0;
        startupColor = "#4682B4";

        personRadius = canvasWidth / 200.0;
        personColor = "#D3D3D3";

        unit = ""

         /* CANVAS SETUP */

        svg = d3.select("#svgCanvas")
                .append("svg")
                .attr("width", canvasWidth  + unit)
                .attr("height", canvasHeight + unit);
        // Add a rectangle so we can always see our canvas size
        svg.append("rect")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("fill", "#faebd7");


        companies = ['Waymo', 'Uber', 'Apple', 'Tesla']
        for (i = 0; i < companies.length; i++) {
            addCompanyBlock(companies[i]);
        }
        svg.selectAll('g.company')
        .attr("transform", function(d, i) {
          return defaultTranslationForCompany(i)
        });

        startups = ['Otto', 'Argo AI', 'Clinsense'];
        for (i = 0; i < startups.length; i++) {
            addStartupBlock(startups[i]);
        }
        svg.selectAll('g.startup')
        .attr("transform", function(d, i) {
          return defaultTranslationForStartup(i)
        });

        people = ['Nisha Pathak', "Lucia D'Onofrio", "Gabe Nicholas"];
        for (i = 0; i < people.length; i++) {
            addPersonBlock(people[i]);
        }
        svg.selectAll('g.person')
        .attr("transform", function(d, i) {
          return defaultTranslationForStartup(i)
        });


        movePersonToCompany("Lucia D'Onofrio", 'Uber', 0, function() {
          movePersonToCompany("Gabe Nicholas", "Uber");
        });

        companies.push('Glusha')
        addCompanyBlock('Glusha')
        svg.selectAll('g.company')
        .transition()
        .delay(5000)
        .duration(1500)
        .attr("transform", function(d, i) {
          return defaultTranslationForCompany(i)
        });

        /* ANIMATIONS */

      function movePersonToCompany(moverName, locationName, delay=1000, callback=function(){}) {

          xOffset = -companyWidth/2 + 5
          yOffset = companyHeight/2 - 10

          function increasePeoplePositions(locationName) {
              d3.select('g#' + idFromName(locationName))
                .selectAll(".person")
                .each(function() {
                  d3.select(this)
                    .attr("personorder", function() {
                      return +d3.select(this).attr("personorder") + 1;
                      // console.log(d)
                      // console.log(d['personorder'])
                      // return d['person-order'] + 1
                  });
                })
            }

          function recalculatePeoplePositions(locationName) {
            d3.select('g#' + idFromName(locationName))
              .selectAll(".person")
              .transition()
              .attr("transform", function() {
                order = +d3.select(this)
                          .attr("personorder");
                console.log(order)
                return peopleTransformForIndex(locationName, order, false)
              });
              
          }

          function peopleTransformForIndex(locationName, i, inSVG=true) {
            nameSpacing = 20;
            xy = []
            if (inSVG == true) {
              xy = centerForId(idFromName(locationName));
            }
            else {
              xy = [companyWidth/2, companyHeight/2];
            }
            translate = translateXY(xy[0] + xOffset,
                                    xy[1] + yOffset - nameSpacing * i)
            return translate;
          }

          xy = centerForId(idFromName(locationName));

          d3.select('g#' + idFromName(moverName))
            .transition()
            .duration(1000)
            .delay(delay)
            .attr("transform", peopleTransformForIndex(locationName, 0))
            .attr("personorder", 0)
            .each("start", function() {
              increasePeoplePositions(locationName);
              recalculatePeoplePositions(locationName);
            })
            .each("end", function(){
              child = this
              d3.select("g#" + idFromName(locationName))
                .append(function() {
                  return child;
                })
                .attr("transform", translateXY(companyWidth/2 + xOffset, companyHeight/2 + yOffset))
              callback();
            });
        }

        /*
         *  LINE DRAWING
         */
        function drawBetweenIds(fromId, toId) {
            start = centerForId(fromId)
            end = centerForId(toId)

            lineData = [{"x" : start[0], "y" : start[1]},
                        {"x" : end[0], "y" : end[1]}];
            lineFunction = d3.svg.line()
                              .x(function(d) { return d.x;})
                              .y(function(d) { return d.y;});
            line = svg.append("path")
                      .attr("d", lineFunction(lineData))                    
                      .attr("stroke", "blue");
        }

        /*
         * PEOPLE METHODS
         */
         function addPersonBlock(name) {
          g = svg.append("g")
              .attr("id", idFromName(name))
              .attr("class", "person");
          g.append("circle")
             .attr("fill", personColor)
             .attr("r", personRadius + unit)
          g.append("text")
            .style("alignment-baseline", "middle")
            .attr("text-anchor", "left")
            .attr("x", 10) // Add a margin
            .attr("y", personRadius/2)
            .text(name)
         }

        /*                  
         * STARTUP METHODS
         */
         function addStartupBlock(name) {
          g = svg.append("g")
              .attr("id", idFromName(name))
              .attr("class", "startup");
          g.append("circle")
             .attr("fill", startupColor)
             .attr("r", startupRadius + unit)
          g.append("text")
            .attr("dy", -startupRadius * 1.1 + unit)
            .style("text-anchor", "middle")
            // .style("alignment-baseline", "middle")
            .text(name);
          return g;
         }

         function defaultTranslationForStartup(i) {
            margin = (canvasWidth - (canvasWidth * (startups.length - 1))/startups.length) / 2;
            x = (canvasWidth * i)/startups.length + margin;
            y = 4 * canvasHeight/5 -startupRadius/2; // Put it 4/5th of the way down
            return translateXY(x, y);
         }

        /*                  
         * COMPANY METHODS
         */

        // Do something where you create a little cubby where people can go
        // Potentially shift around the cubbies as people come in but maybe not
        // Then either still do the add parent/remove parent thing or see if there's
        // an easy way to make one thing follow another.


        function addCompanyBlock(name) {
          startX = (canvasWidth - companyWidth)/2;
          startY = -companyHeight;
          g = svg.append("g")
              .attr("id", idFromName(name))
              .attr("class", "company")
              .attr("transform", translateXY(startX, startY));

          g.append("rect")
              .attr("fill", companyColor)
              .attr("height", companyHeight + unit)
              .attr("width", companyWidth + unit);
          g.append("text")
              .attr("x", companyWidth/2 + unit)
              .attr("y", -5 + unit) // Add a slight margin
              .attr("text-anchor", "middle")
              .attr("alignment-baseline", "top")
              .text(name);

            // .attr("x", 5) // margin
            // .attr("y", companyHeight)
          return g;
        };

        function defaultTranslationForCompany(i) {
            margin = (canvasWidth - (canvasWidth * (companies.length - 1))/companies.length - companyWidth) / 2; // Used to center
            x = (canvasWidth * i)/companies.length + margin;
            y = canvasHeight/5 -companyHeight/2; // Put it 1/5th of the way up
            return translateXY(x, y);
        }

        /*
        * HELPER METHODS
        */

         function idFromName(name) {
          return name.replace(/\W/g, '')
         }

        function translateXY(x, y) {
          return 'translate(' + x + ',' + y + ')';
        }

        function xyTranslate(translate) {
          translate = translate.replace('translate(', '')
          translate = translate.replace(')', '');
          translate = translate.split(',');
          for (var i in translate) {
            translate[i] = +translate[i];
          }
          return translate;
        }

        function centerForId(locationName) {
          isRect = false;
          d3.select('g#' + idFromName(locationName))
            .selectAll("rect")
            .each(function() {
              isRect = true;
            })
          translate = d3.select("g#" + locationName)
                        .attr("transform")
          xy = xyTranslate(translate);
          if (isRect) {
            width = d3.select('g#' + idFromName(locationName))
              .select("rect")
              .attr("width")
            height = d3.select('g#' + idFromName(locationName))
              .select("rect")
              .attr("height");
            xy[0] = xy[0] + width/2;
            xy[1] = xy[1] + height/2;
          }
          return xy;
        }


        </script>
    </body>
</html>  