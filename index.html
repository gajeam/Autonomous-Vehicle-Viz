<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">

        <link rel="stylesheet" href="style/style_overall.css">
        <link rel="stylesheet" href="style/style_past.css">
        <link rel="stylesheet" href="style/style_present.css">
        <link rel="stylesheet" href="style/style_future.css">
        

        <!-- BOOTSTRAP STUFF -->
        <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
        <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
        
        <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
        <script src="https://npmcdn.com/bootstrap@4.0.0-alpha.5/dist/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

        <!-- D3 -->
        <script src="http://d3js.org/d3.v4.min.js"></script>

    <script>
    nextButtonFunction = ""

    function loadPresent() {
        nextButtonFunction = updateData;

        // Shout out to StackOverflow
        // http://stackoverflow.com/a/16788240/1031615
        jQuery.fn.extend({
            disable: function(state) {
                return this.each(function() {
                    var $this = $(this);
                    if($this.is('input, button, textarea, select'))
                      this.disabled = state;
                    else {
                      $this.toggleClass('disabled', state);
                    }
                });
            }
        });


        /* CONSTANTS */

        RADIANS_TO_DEGREES = (360.0/(2 * Math.PI));

        startYear = 2009;
        maxYear = 2017;
        currentYear = maxYear + 1;

        canvasWidth = 745.0;
        canvasHeight = 745.0;

        mainRadius = 250.0;
        mainStrokeWidth = 5.0

        personRadius = 8;
        startupRadius = 18;
        companyRadius = 24;

        personTextSize = 10.0;
        companyTextSize = 14.0;

        kIndexTech = 0;
        kIndexStartUp = 1;
        kIndexCar = 2;

        backgroundColor = "#F0F0F0"
        // green, pink, blue
        baseColors = [ "#32CD32", "#DB7093", "#4682B4",]
        // light to dark order: 2, 4, 1, 3

        colors = [  ["#53D953", "#039403", "#7FE77F", "#09C409",], // greens
                    [ "#EB9CB4", "#9B264C", "#731F35", "#BA456A",], // pinks (replaced lightest shade)
                    ["#6AA0CC", "#12538A", "#9CC3E4", "#2B6BA0",]] // blues
        colorIndex = [0, 0, 0];

        companyTypes = [0, 0, 0]
        companyTypes[kIndexTech] = {
                            'type': 'tech',
                            'color' : baseColors[kIndexTech],
                            'radius' : companyRadius,
                            'name' : "Tech Companies"}
        companyTypes[kIndexCar] = {
                            'type' :'car',
                            'color' :baseColors[kIndexCar],
                            'radius' : companyRadius,
                            'name' : 'Car Companies'}
        companyTypes[kIndexStartUp] ={
                            'type': 'startup',
                            'color' : baseColors[kIndexStartUp],
                            'radius' : startupRadius,
                            'name' : "Startups"};
    
        actionOrder = ["start", "acquire", "found", "rename", "poach", "hire", "sue"];


        industryData = d3.tsv("data/industry.tsv", function(d) {
            people = []
            allData = {};
            for (row in d) {
                item = d[row];
                if (allData[item.year] == undefined) {
                    allData[item.year] = []
                }
                // Separate founding from regular starting
                if (item.action == "start" && item.obj1.length != 0) {
                    item.action = "found";
                }
                // Add info about poaching
                if (item.action == "hire") {
                    if (people.indexOf(item.actor) != -1) {
                        item.action = "poach";
                    } else {
                        people.push(item.actor)
                    }
                }
                allData[item.year].push(item)
            }
            for (y in Object.keys(allData)) {
                year = Object.keys(allData)[y]
                allData[year] = allData[year].sort(function(a, b) {
                    return actionOrder.indexOf(a.action) - actionOrder.indexOf(b.action);
                 });
            }

            setupCanvas();
            updateData();
        })

        d3.tsv("data/companyInfo.tsv", function(d) {
            companyDescriptions = {}
            for (i in d) {
                companyDescriptions[d[i].company] = d[i]
            }
        })

        d3.tsv("data/yearInfo.tsv", function(d) {
            yearDescriptions = {}
            for (i in d) {
                yearDescriptions[d[i].year] = d[i].description
            }
        })


        /*
         *  ANIMATION FUNCTIONS
         */
        function updateData() {
            currentYear++;
            if (currentYear > maxYear) {
                resetCanvas();
                currentYear = startYear - 1;
                updateYearText();
                showTypeLabels(true)
                return;
            }
            runYear(currentYear);
        }

        totalHires = {};
        iteratorHires = {};

        function runYear(year) {
            // Disable the button
            $("#nextButton").disable(true);

            // Show the hover over info text
            d3.select('#company-info-emptystate')
             .style('display', undefined);


            showTypeLabels(false)
            var totalDelay = clearCanvas();

            updateYearText(totalDelay);
            totalDelay = 500.0; // Add some time for switching the year

            // Hack to not cut off the first item
            dataRun = d3.selectAll("something");

            delayInfo = {   "start": [1500, 150], // before, btw
                            "acquire": [1000, 2000],
                            "found": [1000, 10],
                            "rename": [800, 150],
                            "sue": [1000, 1000],
                            "poach": [1800, 50],
                            "hire": [1500, 250]
                        }

            currentAction = ""
            dataRun.data(allData[year])
                    .enter()
                    .filter(function(d) {
                        if (d.action == "poach" || d.action == "hire") {
                            addToHires(d.obj1)
                        }
                        return true;
                    })
                    .each(function(d) {
                        if (d.action != currentAction) {
                            totalDelay += delayInfo[d.action][0]; // add before delay
                            currentAction = d.action;
                        }
                        totalDelay += delayInfo[d.action][1] // add btw delay
                        callAfterDelay(totalDelay, function() {
                            animateAction(d)
                        })
                    })

            callAfterDelay(totalDelay, function() {
                $("#nextButton").disable(false);
                totalHires = {};
                iteratorHires = {};
            });

            function addToHires(d) {
                if (totalHires[d] == undefined) {
                    totalHires[d] = 0;
                }
                totalHires[d] = totalHires[d] + 1;
                iteratorHires[d] = 0;
                totalDelay = 0
                return true;
            }
        }
    
        function animateAction(d, action) {
            action = d.action;
            logAnimations = false;
            if (logAnimations) {
                console.log(d.actor + " " + d.action + " " + d.obj1)
            }

            if (action == "start") {
                addCompany(indexForActorType(d.actorType), d.actor);
            } else if (action == "acquire") {
                acquireStartup(d.actor, d.obj1);
            } else if (action == "found") {
                foundStartup(d.actor, d.obj1.split(', '));
            } else if (action == "rename") {
                changeCompanyName(d.actor, d.obj1);
            } else if (action == "sue") {
                companySuesPerson(d.actor, d.obj1);
            } else if (action == "poach") {
                personPoachedByCompany(d.actor, d.obj1, iteratorHires[d.obj1], totalHires[d.obj1]);
                iteratorHires[d.obj1] = iteratorHires[d.obj1] + 1;

            } else if (action == "hire") {
                addPersonToCompany(d.actor, d.obj1, iteratorHires[d.obj1], totalHires[d.obj1]);
                iteratorHires[d.obj1] = iteratorHires[d.obj1] + 1;
            } else {
                console.warm("No animation for action " + action);
            }
        }


         /*
          * CANVAS
          */
        function setupCanvas() {
            svg = d3.select("#svgCanvas")
                    .append("svg")
                    .attr("width", canvasWidth)
                    .attr("height", canvasHeight)
            
            // Add a rectangle so we can always see our canvas size
            // svg.append("rect")
            //     .attr("width", "100%")
            //     .attr("height", "100%")
            //     .attr("fill", 'red')
            //     .style('opacity', 0.1);

            // Add the different arcs

            centerTransform = translateXY([canvasWidth/2, canvasHeight/2]);
            for (i = 0; i < companyTypes.length; i++) {
                angle = (2/3 * Math.PI);
                var arc = d3.arc()
                    .innerRadius(mainRadius)
                    .outerRadius(mainRadius + 5)
                    .startAngle(angle * i) 
                    .endAngle(angle * (i+1));
                svg.append("path")
                    .attr("id", companyTypes[i].type)
                    .attr("fill", companyTypes[i].color)
                    .attr("d", arc)
                    .attr("transform", centerTransform)
                    .each(function(d) {
                        companyTypes[i]['path'] = this;
                    });
            }

            // Build the main arc for calculating things
            var mainArc = d3.arc()
                            .innerRadius(mainRadius)
                            .outerRadius(mainRadius + 5)
                            .startAngle(0)
                            .endAngle(2 * Math.PI)
            svg.append("path")
                .attr("d", mainArc)
                .attr("id", "mainPath")
                .attr("transform", centerTransform)
                .attr("fill", "none");

            // Add the year text
            yearFont = 45.0;
            margin = 10;
            svg.append("text")
                .attr("id", "yearText")
                .style("font-size", yearFont)
                .attr("x", margin)
                .attr("y", yearFont + margin);


            function setUpTypeLabels() {
                orientations = ["right", "bottom", "left"];
                for (i = 0.0; i < orientations.length; i++) {
                    companyType = companyTypes[i]
                    orient = orientations[i]

                    percentLoc = 1.0/6.0 + (i * 1.0/3.0)
                    radius = 30
                    center = {"x" : canvasWidth * .5, "y" : canvasHeight * .45}
                    margin = (orient == "bottom") ? 120 : 0; // HACK to shift startups further down
                    point = positionForPlaceOnCircle(radius, percentLoc, center)
                    svg.append("g")
                        .attr("transform", translatePoint(point))
                        .append("text")
                        .attr("class", "type-labels")
                        .attr("fill", companyType.color)
                        .attr("font-size", 24)
                        .attr("font-weight", 600)
                        .text(companyType.name)
                        .each(function() {
                            orientText(this, orient, margin, true);
                        })
                }
            }

            setUpTypeLabels();
        }

        function positionForPlaceOnCircle(r, percent,  center) {            
            if (center == undefined) center = {"x": canvasWidth/2.0, "y" : canvasHeight/2.0}
            angle = (Math.PI * 2.0) * percent;         
            center.x = center.x + (Math.sin(angle) * r)
            center.y -= Math.cos(angle) * r 
            return center;
        }

        function testPoint(percent) {
            point = calcArc.node().getPointAtLength(calcArc.node().getTotalLength() * .5 * percent)
            console.log(point)
        }

        function resetCanvas() {
            colorIndex = [0, 0, 0]
            svg.selectAll('g')
                .filter(function() {
                    return ['person', 'tech', 'car', 'startup', 'to-remove', 'to-fade', 'placed-person'].indexOf(d3.select(this).attr("class")) != -1;
                })
                .each(function() {
                    removeElement(this);
                })
        }

        function clearCanvas(duration) {
            // Companies founded should appear at the beginning
            resetFoundingPos();
            // Remove people
            delay = 0.0
            duration = 750.0;
            d3.selectAll(".person")
                .attr("class", "placed-person")

            d3.selectAll(".placed-person")
                .each(function() {
                    delay = duration + 500;
                })
                .transition()
                .duration(duration)
                .ease(d3.easeBack)
                .attr("transform", function() {
                    companyId  = d3.select(this).attr("_companyId");
                    return d3.select("#" + companyId).attr("transform");
                })
                .style("opacity", 0.0)
                .select("circle")
                .attr("fill", function() {
                    return d3.select("#" + d3.select(this.parentNode).attr("_companyId")).select("circle").attr("fill");
                });


            toRemoves = d3.selectAll(".to-remove")
                            .each(function() {
                                removeElement(this)
                            });
            toFades = d3.selectAll(".to-fade")
                        .transition()
                        .duration(250)
                        .style("opacity", 0.0)
                        .on("end", function() {
                            removeElement(this)
                        });
            return delay;
        }

        function removeElement(node, duration) {
            var isCircle = false;
            if (duration == undefined) duration = 250;
            element = d3.select(node)
            element.selectAll("text")
                .transition()
                .duration(duration)
                .attr("fill-opacity", 0);
            element.select("circle")
                        .transition()
                        .duration(duration)
                        .attr("r", 0)
                        .each(function() {
                            isCircle = true;
                        })
                        .on("end", function(){
                            this.parentNode.remove();
                        });
            if (isCircle == false) {
                node.remove();
            }
        }

        function showTypeLabels(show) {
            opacity = (show == true) ? 1.0 : 0.0;
            delay = (show == true) ? 1000.0 : 0.0;
            d3.selectAll(".type-labels")
                .transition()
                .delay(delay)
                .duration(250)
                .attr("opacity", opacity)
        }

        function updateYearText(delay) {
            if (delay == undefined) delay = 0.0;
            callAfterDelay(delay, function() {
                // d3.select("#yearText")
                //     .text(currentYear);
                d3.select("#year-description")
                    .html(yearDescriptions[currentYear])
                d3.select("#year-description-title")
                    .html(function() {
                        return isStartYear() ? "" : currentYear;
                    })
                d3.select("#nextButton")
                    .text(function(){
                        return isStartYear() ? "Start" : "Next year";
                    })
            });
        }

        /*
         *  PEOPLE METHODS
         */

        function addPersonToCompany(personName, companyName, index, total, dashed=true) {
            var company = d3.select("g#" + id(companyName));
            try {
                var startTransform = randomOffsetStart(company)
                var endTransform = personLocationForCompany(companyName, index, total)
            }
            catch (err) {
                console.warn("Cannot find company " + companyName + " for hiring " + personName);
                return;
            }

            var startColor = "#A0A0A0" // Start with a neutral color
            var endColor = company.select("circle").attr("fill");

            var moveTime = 1400
            var person = svg.append("g")
            person.attr("class", "person")
                .attr("id", id(personName))
                .attr("_companyId", company.attr("id"))
                .attr("transform", startTransform)
                .transition()
                .duration(moveTime)
                .attr("transform", endTransform)
                .on("end", function() {
                    var pName = d3.select(this).attr("id")
                    var cName = d3.select(this).attr("_companyId")
                    drawLineFromPersonToCompany(pName, cName, dashed)
                })

            var popTime = 500
            person.append("circle")
                .attr("fill", startColor)
                .attr("r", 0)
                .transition()
                .ease(d3.easeElastic)
                .duration(500)
                .attr("r", personRadius)
                .on("end", function() {
                    d3.select(this)
                    .transition()
                    .duration(moveTime - popTime)
                    .attr("fill", endColor);
                });

            person.append("text")
             .style("opacity", 0.0)
             .text(personName)
             .attr("font-size", personTextSize + "px")
             .each(function() {
                orient = rotateOrientation(company.select("text").attr("_orientation"), 2);
                orientText(this, orient, personRadius, true);
             })
             .transition()
             .delay(250)
             .duration(250)
             .style("opacity", 1.0);


            function randomOffsetStart(company) {
                var companyIndex = indexForActorType(company.attr("class"))
                var percentLoc = 1.0/6.0 + (companyIndex * 1.0/3.0)

                var xRange = 10.0;
                var yRange = -10.0;
                var granularity = 5;

                o = orientationForIndex(companyIndex);
                if (o == "left") { 
                    xRange *= -1
                } else if (o == "top") {
                    yRange *= -1
                }

                xScale = d3.scaleLinear()
                            .domain([0, granularity - 1])
                            .range([Math.min(0, xRange), Math.max(0, xRange)])
                yScale = d3.scaleLinear()
                            .domain([0, granularity - 1])
                            .range([Math.min(0.0, yRange), Math.max(0.0, yRange)])

                x = Math.floor(Math.random() * granularity)
                y = Math.floor(Math.random() * granularity)

                var circRadius = 20

                point = positionForPlaceOnCircle(circRadius, percentLoc)
                point.x += xScale(x)
                point.y += yScale(y)
                return translatePoint(point);
            }
        }




        function personPoachedByCompany(personName, poacherName, index, total) {
            // TODO deal with indices
            person = d3.select("#" + id(personName));

            // Move them to their original company
            try {
                origCompanyId = person.attr("_companyId");
            } catch(err) {
                console.warn("Cannot poach " + personName + " from " + poacherName);
                return;
            }
            origTransform = d3.select("#" + origCompanyId)
                                .attr("transform");
            person.attr("transform", origTransform);
            movePersonToCompany(personName, poacherName, index, total,
                function (){
                  drawLineFromPersonToCompany(personName, poacherName);
              });
        }

        function movePersonToCompany(personName, companyName, index, total, comp, changeColor) {
            if (changeColor == undefined) {
                changeColor = false;
            }

            person = d3.select("#" + id(personName));
            company = d3.select("#" + id(companyName))
            companyColor = company.select("circle")
                                .attr("fill");

            companyTransform = personLocationForCompany(companyName, index, total)
            person.select("text")
                     .each(function() {
                        orient = rotateOrientation(company.select("text").attr("_orientation"), 2);
                        orientText(this, orient, personRadius, true);
                 });

            person.attr("class", "person")
                .attr("_companyId", id(companyName))
                .style("opacity", 1.0) // Show the person again.
                .transition()
                .duration(1800)
                .attr("transform", companyTransform)
                .on("end", comp)
            if (changeColor == true) {
                person.select("circle")
                        .transition()
                        .delay(600) // Wait a bit to change the color
                        .duration(1500)
                        .attr("fill", companyColor)
                    ;
            }

        }
        /*
         *  STARTUP METHODS
         */

         function foundStartup(startupName, founderNames) {
            // Check to see if the founders are on the board
            // NOTE: they either all will be or all won't be.
            var founders = []
            for (f in founderNames) {
                founder = d3.select("#" + id(founderNames[f]));
                if (founder.empty() == false) {
                    founders.push(founder);
                }
            }

            var startup = addCompany(kIndexStartUp, startupName, 1250, posForFounding())
                        .style("opacity", 0.0);

            if (founders.length != 0) {
                callAfterDelay(750, function() {
                    showFounding();
                })
            } else {
                for (i in founderNames) {
                    f = 0;

                    callAfterDelay(1000, function() {
                        var fName = founderNames[f]
                        addPersonToCompany(fName, startupName, f, +founderNames.length, false);
                        f++;
                        startup.transition()
                            .duration(750)
                            .style("opacity",1.0);
                        });
                }
                return;
            }

            function showFounding() {
                for (f in founderNames) {
                    var called = false;
                    var fName = founderNames[f]
                    movePersonToCompany(fName, startupName, +f, +founderNames.length,
                        function() {
                            // if (called == true) return;
                            // called = true;
                            var duration = 0.0;
                            d3.selectAll(".person")
                                .filter(function() {
                                    return founderNames.indexOf(d3.select(this).select("text").text()) != -1;
                                })
                                .each(function() {
                                    duration = animateLineFromPersonToCompany(d3.select(this).attr("id"), startupName);
                                })
                            startup.transition()
                                    .duration(duration)
                                    .style("opacity",1.0);
                        });
                }
            }
         }


         function acquireStartup(acquirerName, startupName) {
            startup = companyTypes[kIndexStartUp];

            acquirer = d3.select("g#" + id(acquirerName));
            acquirerTransform = acquirer.attr("transform")
            acquirerColor = acquirer.select("circle").attr("fill");
            duration = 1500;

            // Move the startup
            svg.select("#" + id(startupName))
                .attr("class", "to-remove")
                .each(function() {
                    addAcquiredCompany(acquirerName, startupName, duration - 500);
                })
                .transition()
                .duration(duration)
                .attr("transform", acquirerTransform)

            acqDelay = 250.0;
            totalAcqDelay = 0.0;
            peopleCount = 0;
            peopleIterator = 0;

            acquiredPeople = svg.selectAll(".placed-person")
                                .filter(function() {
                                    return (d3.select(this).attr("_companyId") == id(startupName)) && (peopleCount += 1);
                                })

            acquiredPeople.attr("_companyId", id(acquirerName))
                .each(function() {
                    peopleIterator++;
                    // Fade the people in
                    d3.select(this).style("opacity", 1.0);
                    d3.select(this).select("circle")
                        .style("opacity", 0.0)
                        .transition()
                        .duration(250.0)
                        .style("opacity", 1.0);


                    d3.select(this).select("text")
                        .style("opacity", 0.0)
                        .transition()
                        .delay(750.0)
                        .duration(250.0)
                        .style("opacity", 1.0);

                    // Move people with the company
                    d3.select(this)
                        .transition()
                        .duration(duration)

                        .delay(function() {
                            totalAcqDelay += acqDelay;
                            return totalAcqDelay; // Make sure this runs after the fade
                        })
                        .attr("transform", function() {
                            return personLocationForCompany(acquirerName, peopleIterator - 1, peopleCount);
                        })
                        .on("end", function() {
                            // d3.select(this).select("circle")
                            // .transition()
                            // .duration(500)
                            // .attr("fill", acquirerColor);
                            drawLineFromPersonToCompany(d3.select(this).attr("id"), acquirerName);

                        })
                });

            // Shift all the other startups
            shiftDelay = 500;
            companyIter = 0;
            companyCount = countCompanyType(startup.type)
            svg.selectAll("." + startup.type)
            .filter(function() {
                return d3.select(this).attr("id") != id(startupName);
            })
            .each(function() {
                d3.select(this)
                    .transition()
                    .delay(shiftDelay)
                    .duration(duration - shiftDelay)
                    .attr("_relIndex", companyIter)
                    .attr("transform", transForEdgeIndex(startup.path, companyIter + 1, companyCount + 1));
                companyIter++;
            });

         }

        /*
         *  COMPANY METHODS
         */

         function addCompany(indexType, name, time, newIndex) {
            if (time == undefined) {
                time = 750.0;
            }
            company = companyTypes[indexType];
            companyCount = countCompanyType(company.type);
            companyIter = 0;
            color = colors[indexType][colorIndex[indexType]];
            colorIndex[indexType] = (colorIndex[indexType] + 1)%(colors[indexType].length);

            if (newIndex == undefined) newIndex = companyCount;

            // Shift all the other companies
            var afterId = undefined;

            svg.selectAll("." + company.type)
                .each(function() {
                    if (companyIter == newIndex) {
                        // Find the element to insert the new element after
                        afterId = '#' + d3.select(this).attr('id')
                        companyIter++; // Skip the location we're adding to
                    }
                    d3.select(this)
                        .attr("_relIndex", companyIter)
                        .transition()
                        .duration(time)
                        .attr("transform", transForEdgeIndex(company.path, companyIter + 1, companyCount + 2));
                    companyIter++;
                });

            g = svg.insert("g", afterId)
                .attr("class", company.type)
                .attr("id", id(name))
                .attr("_relIndex", newIndex)
                .attr("transform", transForEdgeIndex(company.path, newIndex + 1, companyCount + 2))

            g.append("circle")
            .attr("fill", color)
            .attr("r", 0)
            .transition()
                .attr("r", company.radius);

            var text = g.append("text")
                         .attr("fill-opacity", 1.0)
                         .attr("font-size", companyTextSize + "px")
                          // .each(function() {
                          //       orientText(this.parentNode, orientationForIndex(indexType), company.radius)
                          //    });

            // if (indexType == kIndexStartUp) {
                splitWords = (indexType == kIndexStartUp) ? name.split(' ') : [name];
                for (i in splitWords) {
                        text.append('tspan')
                         .text(splitWords[i])
                         .attr('x', 0)
                         .attr('y', companyTextSize * 2.0)
                         .attr('dy', i * companyTextSize)
                       .each(function() {
                            orientText(this, orientationForIndex(indexType), company.radius)
                         });
                         // .attr('alignment-baseline', function() {
                         //    if (indexType == kIndexStartUp) {
                         //        return 'baseline'
                         //    } return undefined;
                         // })
                }

            // }

            function textFromTspans(textNode) {
                textVals = []
                d3.select(textNode)
                .selectAll('tspan')
                .each(function() {
                    textVals.push(d3.select(this).text())
                });
                return textVals.join(' ')
            }

             g.select("circle")
                .on("mouseover", function(d) {
                     // Do this because the name might change
                    companyName = textFromTspans(d3.select(this.parentNode).select("text").node())
                    var company = companyDescriptions[companyName];
                    var infoCont = d3.select("#company-info")

                    d3.select('#company-info-emptystate')
                        .style('display', 'none');
                    d3.select('#company-info')
                        .style('display', undefined)

                    infoCont.select("#company-name").html(companyName);
                    infoCont.select("#company-description").html(company.description)


                    hasEmployees = false;
                    d3.selectAll("g")
                        .filter(function() {
                            return d3.select(this).attr("_companyId") == id(companyName) && (hasEmployees = true);
                        })
                        .call(function() {
                            if (hasEmployees == true) {
                                infoCont.select("#company-employees-title")
                                        .style('display', undefined);
                                infoCont.select("#company-employees-title").html("Employees as of " + currentYear);
                            } else {
                                infoCont.select("#company-employees-title")
                                        .style('display', 'none')
                            }
                        })
                        .each(function() {
                            infoCont.select("#company-employee-list")
                                    .append("li")
                                    .html(d3.select(this).select("text").text())
                        })
                        .call(function() {
                            infoCont.select("#company-source").html("<i>Source: " + company.source)
                        })
             })
             .on("mouseout", function(d) {
                d3.select('#company-info-emptystate')
                    .style('display', undefined);
                d3.select('#company-employee-list')
                    .html('')
                d3.select('#company-info')
                    .style('display', 'none')
             });

            return g;
        }


        function changeCompanyName(fromName, toName) {
            company = d3.select("#" + id(fromName));
            fadeDuration = 500;
            fadeInDelay = 250;
            // Fade out the text, change the name, fade it in with the new name
            company.attr("id", id(toName));
            company.select("text")
                    .transition()
                    .duration(fadeDuration)
                    .style("opacity", 0.0)
                    .on("end", function() {
                        d3.select(this)
                            .select('tspan')
                            .text(toName)
                        d3.select(this)
                            .transition()
                            .delay(fadeInDelay)
                            .duration(fadeDuration)
                            .style("opacity", 1.0);
                    });

            svg.selectAll(".placed-person")
                .filter(function() {
                    return (d3.select(this).attr("_companyId") == id(fromName));
                })
                .attr("_companyId", id(toName));
        }

        function addAcquiredCompany(companyName, acquiredName, delay) {
            company = d3.select("#" + id(companyName));
            acquired = d3.select("#" + id(acquiredName));

            companyText = company.selectAll("text").last();
            companyTextX = +companyText.attr("x");
            companyTextY = +companyText.attr("y");
            companyTextY += companyTextSize + 7.0;

            acquired.selectAll("text")
                    .transition()
                    .delay(delay - 250)
                    .duration(250)
                    .style("opacity", 0.0);

            console.log(companyText.attr('_orientation'));
            company.insert("text")
                    .attr("class", "to-fade")
                    .text(acquiredName)
                    .each(function() {
                            orientText(this, companyText.attr('_orientation'), companyRadius, true);
                        })
                    .attr("x", function() {
                        return +d3.select(this).attr("x") + companyTextX;
                    })
                    .attr("y", companyTextY)
                    .attr("font-style", "italic")
                    .attr("font-size", companyTextSize + "px")
                    .attr("fill", acquired.select("circle").attr("fill"))
                    .style("opacity", 0.0)
                    .transition()
                    .delay(delay)
                    .duration(250)
                    .style("opacity", 1.0);
        }

        function companySuesPerson(plaintiffName, defendantName) {
            plaintiffCenter = accessPointForId(plaintiffName);
            defendantCenter = accessPointForId(defendantName);

            var startLineData = [plaintiffCenter,plaintiffCenter];
            var endLineData = [plaintiffCenter, defendantCenter];
            var lineFunction = d3.line()
                  .x(function(d) { return d.x;})
                  .y(function(d) { return d.y;});


            var arrowColor = "red"
            // Shout out to this JSFiddle
            // https://jsfiddle.net/owen_rodda/55zk55ut/16/
            svg.append("defs").append("marker")
                .attr("id", "arrow-sue")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 8)
                .attr("fill", arrowColor)
                .attr("refY", 0)
                .attr("markerWidth", 5)
                .attr("markerHeight", 7)
                .attr("orient", "auto")
              .append("svg:path")
                .attr("d", "M0,-5L10,0L0,5");


            svg.insert("g", "#mainPath")
                .attr("class", "to-remove")
                .append("path")
                .attr("d", lineFunction(startLineData))
                .attr("stroke", arrowColor)
                .attr("stroke-width", 3)
                .style("opacity", .5)
                .attr("stroke-dasharray", 8)
                .attr("marker-end", "url(#arrow-sue)")
                .transition()
                .duration(1000)
                  .attr("d", lineFunction(endLineData))

            function accessPointForId(identifier, indexType) {
                element = d3.select("#" + id(identifier));
                translate = xyTranslate(element.attr("transform"));
                return {"x": translate[0], "y": translate[1]}
            }
        }

         // COMPANY HELPER FUNCTIONS

         function transForEdgeIndex(companyPath, index, total) {
            trans = xyTranslate(d3.select(companyPath).attr("transform"));
            path = companyPath
            totalLength = path.getTotalLength();
            newPoint = path.getPointAtLength((index/total) * (totalLength/2));
            trans[0] = newPoint.x + trans[0];
            trans[1] = newPoint.y + trans[1];
            return translateXY(trans)
        }

        function countCompanyType(companyType) {
            companyCount = 0;
            svg.selectAll("." + companyType)
                .each(function() {
                    companyCount++;
                });
            return companyCount;
        }

        function personLocationForCompany(companyName, index, total) {
            element = d3.select("#" + id(companyName));
            translate = pointTranslate(element.attr("transform"));

            radialDiff = Math.PI * .9;
            radians = complement(radiansOfCompany(companyName));
            radians += radialDiff/2.0 - (radialDiff * (index + 1)/(total + 1));
            // Hack to get around negative percents
            if (radians < 0.0) {
                radians += 2.0 * Math.PI
            }
            percent = radians /(2.0 * Math.PI);

            point = positionForPlaceOnCircle(70, percent, translate)            
            return translatePoint(point)
        }

        /*
        * HELPER METHODS
        */

        function animateLineFromPersonToCompany(personName, companyName, dashed=false) {
            person = d3.select("#" + id(personName));
            personCenter = pointTranslate(person.attr("transform"))

            company = d3.select("#" + id(companyName));
            companyCenter = pointTranslate(company.attr("transform"));
            var startLineData = [personCenter,personCenter];
            var endLineData = [personCenter, companyCenter];
            var lineFunction = d3.line()
                  .x(function(d) { return d.x;})
                  .y(function(d) { return d.y;});

            var duration = 750;
            personLine(personName, dashed)
                .attr("d", lineFunction(startLineData))
                .transition()
                .duration(duration)
                .attr("d", lineFunction(endLineData))
            return duration;
        }

        function drawLineFromPersonToCompany(personName, companyName, dashed=true) {
            person = d3.select("#" + id(personName));
            personCenter = xyTranslate(person.attr("transform"))

            company = d3.select("#" + id(companyName));
            companyCenter = xyTranslate(company.attr("transform"));

            var lineData = [{"x": personCenter[0], "y": personCenter[1]},
                            {"x": companyCenter[0], "y": companyCenter[1]}];

            var lineFunction = d3.line()
                  .x(function(d) { return d.x;})
                  .y(function(d) { return d.y;});


            personLine(personName, dashed)
                .attr("d", lineFunction(lineData))
                .style("opacity", 0.0)
                .transition()
                .duration(500)
                .style("opacity", 1.0);
        }

        function personLine(personName, dashed=true) {
            return svg.insert("g", "#" + id(personName))
                .attr("class", "to-remove")
                .append("path")
                .attr("stroke", company.select("circle").attr("fill"))
                .attr("stroke-width", 1.0)
                .attr("stroke-dasharray", function() {
                    return dashed ? 4 : undefined;
                })
                .style("opacity", 1.0);

        }

        function radiansOfCompany(companyName) {
            element = d3.select("#" + id(companyName));
            relIndex = +(element.attr("_relIndex"));
            type = element.attr("class")
            elementCount = 0.0;

            d3.selectAll("." + type)
                .each(function() {
                    elementCount++;
                });

            smallArc = (2.0/3.0 * Math.PI)
            radians = smallArc * parseFloat(indexForActorType(type))
            radians += smallArc * (relIndex + 1.0)/(elementCount + 1.0)
            return radians;
        }

        function complement(radians) {
            // Hacky but it works.
            if (radians == Math.PI || radians == -Math.PI) return 0.0;
            if (radians < Math.PI) c = Math.PI + radians;
            else c = radians - Math.PI;
            return +c;
        }

        function orientText(element, orientation, radius, isText=false) {
            margin = 4.0;

            baseline = "middle"
            textAnchor = "middle"
            offset = radius + margin;
            x = 0;
            y = 0;

            if (orientation == "right") {
                x = offset;
                textAnchor = "left";
            } else if (orientation == "left") {
                x = -offset;
                textAnchor = "end";
            } else if (orientation == "bottom") {
                y = offset;
                baseline = "hanging";
            } else if (orientation == "top") {
                y = -offset;
                baseline = "baseline";
            } else {
                console.warn("Bad orientation " + orientation);
                return;
            }

            d3.select(element)
                .style("alignment-baseline", baseline)
                .attr("text-anchor", textAnchor)
                .attr("x", x)
                .attr("y", y)

            textElement = (isText == true) ? element : element.parentNode;
            d3.select(textElement)
                .attr("_orientation", orientation);
        }

        function rotateOrientation(o, cardDegrees) {
            // Each cardDegree turns it 90 degrees to the right
            orientations = ["top", "right", "bottom", "left"];
            return orientations[(orientations.indexOf(o) + 2)%4]
        }

        function orientationForIndex(companyIndex) {
            if (companyIndex == 0) return "right";
            if (companyIndex == 1) return "bottom";
            if (companyIndex == 2) return "left";
        }

        function callAfterDelay(delay, func) {
            setTimeout(func, delay);
        }

        function translateXY(xy) {
          return 'translate(' + xy[0] + ',' + xy[1] + ')';
        }

        function xyTranslate(translate) {
          translate = translate.replace('translate(', '')
          translate = translate.replace(')', '');
          translate = translate.split(',');
          for (var i in translate) {
            translate[i] = +translate[i];
          }
          return translate;
        }

        function pointTranslate(translate) {
          translate = translate.replace('translate(', '')
          translate = translate.replace(')', '');
          translate = translate.split(',');
          return {"x" : +translate[0], "y" : +translate[1]};
        }

        function translatePoint(point) {
            return 'translate(' + point.x + ',' + point.y + ')'
        }

        function indexForActorType(cType) {
            if (cType == "tech") {
                return kIndexTech;
            } else if (cType == "car") {
                return kIndexCar;
            } else if (cType == "startup") {
                return kIndexStartUp;
            } else {
                console.warn("Bad type " + cType);
            }
        }


        function isStartYear() {
            return currentYear == startYear - 1;
        }
        function id(name) {
          return name.replace(/\W/g, '')
        }

        // Get the first or last child
        // Shout out to StackOverflow
        // http://stackoverflow.com/a/25413534/1031615
        d3.selection.prototype.first = function() {
            return d3.select(this.nodes()[0])
        };
        d3.selection.prototype.last = function() {
            return d3.select(this.nodes()[this.nodes().length-1])
        };



         foundingPos = 0
         function posForFounding() {
            retVal = undefined
            if (foundingPos%3 == 1) retVal = 0
            if (foundingPos%3 == 2) {
                retVal = 0;
                d3.selectAll('.startup')
                    .each(function() {
                        retVal++
                    })
                    .call(function() {
                        retVal =  Math.floor(retVal/2);
                    })
            }
            foundingPos++;
            return retVal;
         }

         function resetFoundingPos() {
            foundingPos = 0;
         }
    }

    function loadFuture() {
        var margin = {top: 10, right: 90, bottom: 50, left: 50},
            width = 750 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        /*
         * value accessor - returns the value to encode for a given data object.
         * scale - maps value to a visual display encoding, such as a pixel position.
         * map function - maps from data value to display value
         * axis - sets up axis
         */ 

        // setup x 
        var xValue = function(d) { return d.Year;}, // data -> value
            xScale = d3.scaleLinear().range([0, width]), // value -> display
            xMap = function(d) { return xScale(xValue(d));}, // data -> display
            xAxis = d3.axisBottom().scale(xScale).ticks(8)
                    .tickFormat(d3.format("d")).tickSizeOuter(0);

        // setup y

        var ticks = [0,1,2,3,4,5];
        var tickLabels = ["N/A",1,2,3,4,5];

        var yValue = function(d) { return d["Level"];}, // data -> value
            yScale = d3.scaleLinear().range([height, 0]), // value -> display
            yMap = function(d) { return yScale(yValue(d));}, // data -> display
            yAxis = d3.axisLeft().scale(yScale).tickValues(ticks)
                    .tickFormat(function(d,i){ return tickLabels[i] }).tickSizeOuter(0);


        // setup fill color
        // var cValue = function(d) { return d.bl;};
        // color = d3.scaleOrdinal(d3.schemeCategory10);

        // add the graph canvas to the body of the webpage
        var svg = d3.select("#scatterplot").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        // add the tooltip area to the webpage
        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // load data
        d3.csv("data/ship_dates.csv", function(error, data) {

        /*
         * @NISHA Here are all the future graph colors you can change
         */

         var dotColor = "#EACB49";
         var dotOpacity = .6;

         var boxColor = "#a27eb8";
         var boxOpacity = .4;

         //////////////////////////

          // change string (from CSV) into number format
          data.forEach(function(d) {
            d.Year = +d.Year;
            d["Level"] = +d["Level"];
          });

          // don't want dots overlapping axis, so add in buffer to data domain
          xScale.domain([d3.min(data, xValue)-0.2, d3.max(data, xValue)+0.2]);
          yScale.domain([d3.min(data, yValue)-0.5, d3.max(data, yValue)+0.2]);

          // x-axis

          xAxisTranslateX = (width + margin.right)/2.0;
          xAxisTranslateY = margin.bottom - 5;
          svg.append("g")
              .attr("class", "x-axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
            .append("text")
              .attr("class", "x-label")
              .attr("transform", "translate(" + xAxisTranslateX + "," + xAxisTranslateY + ")")
              .style("text-anchor", "end")
              .style("font-style", "italic")
              .text("Expected Ship Year");

          // y-axis

          yAxisTranslateX = -margin.left;
          yAxisTranslateY = (height - margin.top - margin.bottom)/2.0 - 30; // It looks gross in the middle so we moved it up a bit
          svg.append("g")
              .attr("class", "y-axis")
              .call(yAxis)
            .append("text")
              .attr("class", "y-label")
              .attr("transform", "translate(" + yAxisTranslateX + "," + yAxisTranslateY + ")rotate(-90)")
              .attr("y", 6)
              .attr("dy", ".71em")
              .style("font-style", "italic")
              .style("text-anchor", "end")
              .text("Level of Autonomy");

            // add rectangle
            svg.append("rect")
                .attr("id", "NANs")
                .attr("x", 0)
                .attr("y", height*(5/6))
                .attr("width", width)
                .attr("height", height/6)
                .attr("fill", boxColor)
                .attr("fill-opacity", boxOpacity);


          // draw info box
          var infoBox = d3.select("#infoBox")
            .style('width', width + "px")
            .style("margin-left", (margin.left - 15) + "px") // HACK: These are made up numbers
            // .style("margin-right", (margin.right+85) + "px")
            .style("opacity", 0.9);

          // draw dots
          svg.selectAll(".dot")
              .data(data)
            .enter().append("circle")
              .attr("class", "dot")
              .attr("r", 5)
              .attr("cx", xMap)
              .attr("cy", yMap)
              .style("fill", dotColor)
              .style("opacity", dotOpacity)
              .style("stroke", "black")
              .on("mouseover", function(d) {
                  tooltip.transition()
                       .duration(200)
                       .style("opacity", .9);
                  tooltip.html(d["Company"])
                       .style("left", (d3.event.pageX + 5) + "px")
                       .style("top", (d3.event.pageY - 28) + "px")
                       .style("font-size", "12px");


                  infoBox.select('p').remove();
                  infoBox.append("h4").text(d["Company"]);
                  ul = infoBox.append("ul");
                  var bullet_points = d["Comments"].split("; ");
                  for (i in bullet_points) {
                    point = bullet_points[i];
                    ul.append("li")
                        .text(point)
                        .style("font-size", "14px");
                  }


              })

              .on("mouseout", function(d) {
                  tooltip.transition()
                       .duration(500)
                       .style("opacity", 0);
                  resetInfoBox();
              });
              

              function resetInfoBox() {
                infoBox.select("h4").remove()
                infoBox.append("p").text("Hover over the dots to find out more about each company and their promises")
                        .style("font-style", "italic");
                try {
                    ul.remove();
                 } catch (err){
                }
              }

              resetInfoBox()
            });
    }

    </script>
    </head>

    <body>

    <div class="container-fluid">

        <div class="row topic-row" id="title-row">
            <div class="overlay">
                <div id="title-text">
                    <h3>
                    AUTONOMOUS VEHICLES: PAST, PRESENT, FUTURE
                    </h3>
                    <p> Hello from the other side </br>
                        I must have called a thousand times </br>
                        To tell you I'm sorry for everything that I've done </br>
                        But when I call you never seem to be home </p>
                </div>
            </div>     
        </div>

        <div class = "row topic-row" id="past-row">
          <div class="row">
            <div class="col">
                <div id="past-text" class="explaining-text">
                    <h3>
                        THE PAST
                    </h3>
                    <p>
                    In 2003, the United States’ Defense Advanced Research Projects Agency (DARPA) launched The Grand Challenge to spur the innovation of unmanned, remote controlled ground vehicles. This event was the first of its kind and the technologies developed for these competitions have undoubtedly supported and accelerated the progress we have seen within the autonomous vehicle industry.
                    </p>
                </div>
            </div>
          </div>
            <div class="row">
                <img src="img/DARPA.svg" id="darpa-graph"/>
            </div>
        </div>

        <div class = "row topic-row" id="present-row">
          <div class="row">
            <div class="col">
                <div id="present-text" class="explaining-text">
                    <h2>
                        THE PRESENT
                    </h2>
                    <p> But like, seeing dots moving is even cooler, so that's what you'll get to see now.</br>
                        So MANY dots moving, it's unreal - ENJOY! </p>
                </div>
            </div>
          </div>
          <div class ="row">
            <div class = "col-5">
                <div id="present-data-display">
                    <div class = "row present-info" id="year-info-cont">
                        <div class= "info-text-box">
                            <h1 id="year-description-title"></h1>
                            <p id="year-description"></p>
                            <div class = "d-flex justify-content-center">
                                <button type="button"
                                    class="btn"
                                    id="nextButton"
                                    onclick="nextButtonFunction()">Start
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class = "row present-info" id="company-info-cont">
                        <div id='company-info' style='display:none'>
                            <h3 id='company-name'></h3>
                            <p id='company-description'></p>
                            <h5 id='company-employees-title'></h5>
                            <ul id='company-employee-list'></ul>
                            <p id ='company-source'></p>
                        </div>
                        <div id='company-info-emptystate' style='display:none;'>
                            <p>Hover over the dots to find out more about each company and person.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-7 svg-container">
                <div id="svgCanvas"></div>
            </div>
          </div>
        </div>

        <div class = "row topic-row" id="future-row">
          <div class="row">
            <div class="col">
                <div id="future-text" class = "explaining-text">
                    <h2>
                        THE FUTURE
                    </h2>
                    <p> Also, I think most of these companies are lying</br>
                        I can't believe we'll have level 5 in 2017 - not a chance...</p>
                </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-5">
                <div id="table-container">
                    <table class="table table-condensed">
                        <thead>
                          <tr>
                            <th>Level of Autonomy</th>
                            <th class = "des">Description of </br> Autonomy Level</th>
                            <th>Vehicle Example</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <th scope="row">5</th>
                            <td class = "des"><b>Most autonomy.</b> The vehicle performs as well as a human driver in any type of scenario.</td>
                            <td>Volkswagen Sedric</td>
                          </tr>
                          <tr>
                            <th scope="row">4</th>
                            <td class = "des">The vehicle controls "all safety-critical driving functions and monitors roadway conditions for an entire trip." Yet, the driver is still necessary in scenarios that are outside of the "operational design domain (ODD)."</td>
                            <td>Ford Fusion Hybrid</td>
                          </tr>
                          <tr>
                            <th scope="row">3</th>
                            <td class = "des"> <b>Middle autonomy.</b> The driver is necessary, but in specific traffic or environmental conditions all "safety-critical functions" are controlled by the vehicle. The driver may need to intervene depending on the situation, but does not have to monitor as much as in the other levels. Many companies are considering skipping level 3 as it requires people to go from a state of inattentiveness to one of alertness very quickly.</td>
                            <td>Tesla Model S</td>
                          </tr>
                            <th scope="row">2</th>
                            <td class = "des">At least one driver assistance system, like steering and acceleration/deceleration is automated. The vehicle can gauge when to engage these systems based on understanding the driving environment. Automated processes also include cruise control and lane-centering. While not actively using hands or feet, the driver must always pay attention and be ready to take control of the vehicle at any time.</td>
                            <td>Mercedes-Benz E-Class</td>
                          </tr>                 
                          <tr>
                            <th scope="row">1</th>
                            <td class = "des"> <b>Least autonomy.</b> The driver is still in control of most of the driving, but functions like steering or accelerating are controlled by the car.</td>
                            <td>Audi A7</td>
                          </tr>
                        </tbody>
                    </table>
                  </div>
            </div>
            
            <div class="col-1">
            </div>

            <div class="col-6">

              <div class = "row">
                <div id="scatterplot">
                </div>
              </div>

              <div class = "row">

                <div class="col">
                  <div id="infoBox">
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
    </div>

    <script type="text/javascript">
        loadPresent();
        loadFuture();
    </script>
    </body>


</html>